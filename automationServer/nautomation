[{"id":"1c2d6e78.ff8e7a","type":"tab","label":"Flow 1","disabled":false,"info":""},{"id":"3ccc980d.314d4","type":"socketio-config","port":"80","sendClient":"true","path":"/socket.io","bindToNode":true},{"id":"2b836cd.3aa9214","type":"tls-config","name":"","cert":"","key":"","ca":"","certname":"","keyname":"","caname":"","servername":"","verifyservercert":false},{"id":"ea78eae2.f9578","type":"tls-config","name":"","cert":"","key":"","ca":"","certname":"","keyname":"","caname":"","servername":"","verifyservercert":false},{"id":"bb2f6fb4.d4be2","type":"sqlitedb","db":"/root/demobuilder.db","mode":"RW"},{"id":"18c5ccd5.ef404b","type":"mqtt-broker","name":"","broker":"localhost","port":"1883","clientid":"","usetls":false,"compatmode":false,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"403dd372.8600f4","type":"sqlitedb","db":"/root/sec.db","mode":"RO"},{"id":"3bc84f4e.84ed1","type":"http in","z":"1c2d6e78.ff8e7a","name":"","url":"/m/:company/:cid","method":"get","upload":false,"swaggerDoc":"","x":100,"y":80,"wires":[["552c2e95.869f2"]]},{"id":"5bfcecd3.14b81c","type":"http response","z":"1c2d6e78.ff8e7a","name":"","statusCode":"","headers":{},"x":1470,"y":80,"wires":[]},{"id":"a0849a.76e05368","type":"template","z":"1c2d6e78.ff8e7a","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<html><head><link rel=\"stylesheet\" type=\"text/css\" href=\"/static/css/bundle.s41.css\">\n<link rel=\"stylesheet\" href=\"https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css\">\n    \n<title>{{company}} Demo</title>\n<link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css\" rel=\"stylesheet\" integrity=\"sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1\" crossorigin=\"anonymous\">\n<link rel=\"stylesheet\" href=\"https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css\">\n <style>\n     a:hover{\n         border:0;\n         color:red;\n     }\n     a{\n         text-decoration:none;\n     }\n </style>\n \n </head>\n<div class=\"container\" style=\"width: 70rem\">\n  <div class=\"row\">\n    <div class=\"col-9\">\n        <div class=\"jumbotron jumbotron-fluid\">\n            <h1 class=\"display-6\"><center>{{htitle}}</center></h1>\n            {{{prov}}}\n            <br>\n            <p>If you run into problems reach out to Garrett - garrett.rowe@us.ibm.com<br>IBMers: join our slack channel for support, requests, updates and feedback: <a href=\"slack://channel?team=T08LVDR7Y&id=C020JAN9H8U\">#demobuilder</a></p>\n    </div>\n    <div class=\"col-sm\" style=\"padding-bottom:20px;\">\n      <img src=\"../../{{company}}.png\" style=\"padding-top: 50px; width:150px\">\n    </div>\n  </div>\n\n    <div class=\"card\" style=\"width: 60rem;\">\n        <div class=\"card-header\">\n            <div class=\"row\">\n                <div class=\"col-3\">Deployment</div>\n                <div class=\"col-8 progress\">\n                    <div class=\"progress-bar progress-bar-striped progress-bar-animated\" role=\"progressbar\"  style=\"width: 0%\"></div>\n                </div>\n            </div>\n        </div>\n        <div class=\"card-body\">\n            <p class=\"card-text\" id=\"log\"></p>\n        </div>\n    </div>\n    <div class=\"card\" style=\"width: 60rem;\">\n        <div class=\"card-header\">Demo Links - When prompted for a password, use \"ibm\" for the user and password</div>\n        <div class=\"card-body\">\n            <p class=\"card-text\" id=\"completel\"></p>\n        </div>\n    </div>\n    <div id='dacontrol'></div>\n</div>\n\n<script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js\" integrity=\"sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW\" crossorigin=\"anonymous\"></script>\n<script src=\"https://code.jquery.com/jquery-3.5.1.min.js\" integrity=\"sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=\" crossorigin=\"anonymous\"></script>\n<script src=\"../../socket.io/socket.io.js\"></script>\n<script src=\"https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js\"></script>\n<script>\nvar socket = io();\nvar progress = 0;\nvar owner = null;\n\n$(function(){\n    var comp = `{{{comp}}}`;\n    if (comp != \"\"){\n        $(\"#completel\").html(comp);\n        $('.progress-bar').css('width', '100%');\n        $('.progress-bar').removeClass('progress-bar-striped').removeClass('progress-bar-animated').addClass('bg-success');\n    \n        startDaControl();\n    }\n});\n    \nsocket.on('connect', function() {\n    console.log(\"socket connected\");\n});\nsocket.on('disconnect', function() {\n\tconsole.log(\"socket disconnected\");\n});\n\nsocket.on('owner', function(data) {\n    if(data.inst == \"{{cid}}\"){\n        console.log(JSON.stringify(data));\n        owner = data.owner;\n    }\n});\n\nsocket.on('log', function(data) {\n    if(data.Instance == \"{{cid}}\"){\n\t    $(\"#log\").append(\"<i class='bi-gear' style='padding-right:10px'></i>\" + data.Log + \"<br>\");\n\t    prog();\n    }\n});\nsocket.on('trashit', function(data) {\n    if(data.instnum == \"{{cid}}\"){\n\t    $(\"#log\").html(\"<br><br><p> Hi, \" + data.owner + \".  Despite the warnings, you chose to continue without the correct account type.  Your instance is in the process of failing now.  You will first need to destroy this instance.  Where you clicked 'Apply Plan' - choose 'destroy' under the 'Actions' dropdown.  Then please re-read the directions and get your account upgraded before trying again. </p>\");\n\t    prog();\n    }\n});\nsocket.on('complete', function(data) {\n    if(data.Instance == \"{{cid}}\"){\n        if (owner != null){\n            Cookies.set('owner', owner, { expires: 999, sameSite: 'none', secure: true });\n        }\n        $(\"#log\").append(\"<br><br><center>Invite IBM and customer POC members by granting access to the <a href='https://cloud.ibm.com/iam/users/invite_users' target='_blank'>{{company}} Access Group</a>.  They'll only be able to see this POC's resources.<br><br>Bookmark this page.  It is your key to the demo links below</center><br>\");\n\t    $(\"#completel\").html(`{{{demolinks}}}`);\n        $('.progress-bar').css('width', '100%');\n        $('.progress-bar').removeClass('progress-bar-striped').removeClass('progress-bar-animated').addClass('bg-success');\n    \n        startDaControl();\n    }\n});\nfunction getDaControl(){\n    try{\n        $.ajax\n        ({\n          type: \"GET\",\n          url: \"/dacontrol?inst={{cid}}\",\n          dataType: \"html\",\n          success: function (data){\n              if(!$(\"#dalog\").is(\":visible\") && !$(\"#daurl\").is(\":focus\"))\n                $(\"#dacontrol\").html(data);\n          }\n        });\n    }catch(f){}\n}\nfunction startDaControl(){\n    getDaControl();\n    setTimeout(startDaControl, 1800000);\n}\n    \nfunction prog(){\n    progress +=1;\n    $('.progress-bar').css('width', ((progress/27)*100)+'%');\n}\n\n$(\"#startTerraform\").click(function(e) {\n    $(\"#log\").append(\"<center>Creating Workspace.  If progress stalls, check to see if the plan failed.  If it did, just click the 'Apply Plan' button again.<br>Do not refresh this page while your instance is provisioning.</center><br>\");\n    prog();\n});\n    \n</script>","output":"str","x":1260,"y":80,"wires":[["5bfcecd3.14b81c"]]},{"id":"8697e700.887bf8","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"msg.topic = msg.payload.Instance;\nif (typeof msg.payload.Log != \"undefined\") {\n    if (msg.payload.Log.length > 0){\n        msg.socketIOEvent = \"log\";\n        node.send([msg, null]);\n    }\n}\nif (typeof msg.payload.Log != \"undefined\") {\n    if (msg.payload.Log == \"Starting Terraform\")\n        node.send([null,msg]);\n}\nif (typeof msg.payload.complete != \"undefined\") {\n    msg.socketIOEvent = \"complete\";\n    msg.payload.data = flow.get(msg.payload.Instance);\n    node.send([msg, null]);\n}\n","outputs":2,"noerr":0,"initialize":"","finalize":"","x":300,"y":320,"wires":[["9c8ff97c.1818","b59e9bfd.323e9"],["f8681484.79fe78","d05533c8.652948","aaf3bc53.f4b608"]]},{"id":"552c2e95.869f2","type":"function","z":"1c2d6e78.ff8e7a","name":"f","func":"msg.cid = msg.req.params.cid;\nmsg.company = msg.req.params.company;\nmsg.filename = \"/root/scrape/\" + msg.company + \".txt\";\n\nmsg.topic = \"select provisioned from provisioned p  where p.instance like '\" + msg.cid + \"' or p.instance like '\" + msg.company + \"-\" + msg.cid + \"' and p.provisioned IS NOT NULL order by p.provisioned\";\n\n\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":270,"y":80,"wires":[["7e7e834b.898e24"]]},{"id":"9c8ff97c.1818","type":"socketio-out","z":"1c2d6e78.ff8e7a","name":"","server":"3ccc980d.314d4","x":500,"y":300,"wires":[]},{"id":"4d5f901.54df87","type":"http in","z":"1c2d6e78.ff8e7a","name":"","url":"/log","method":"post","upload":false,"swaggerDoc":"","x":140,"y":320,"wires":[["c301b9fa.2ee74","8697e700.887bf8"]]},{"id":"c301b9fa.2ee74","type":"http response","z":"1c2d6e78.ff8e7a","name":"","statusCode":"","headers":{},"x":330,"y":380,"wires":[]},{"id":"f6f1feaa.5a054","type":"http in","z":"1c2d6e78.ff8e7a","name":"","url":"log","method":"get","upload":false,"swaggerDoc":"","x":140,"y":360,"wires":[["c301b9fa.2ee74","8697e700.887bf8"]]},{"id":"53793006.c32668","type":"exec","z":"1c2d6e78.ff8e7a","command":"node scrape.js","addpay":true,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"","x":660,"y":160,"wires":[["be08f0bb.afd88"],[],[]]},{"id":"94b53b23.1d7c98","type":"function","z":"1c2d6e78.ff8e7a","name":"f","func":"try{\n    msg.url = msg.instJSON.url;\n} catch(fail){\n    msg.url = \"Couldn't find website.  User the override on the previous page\";\n}\ntry{\n    if (msg.instJSON.plan == \"plus_V2\")\n        msg.demolinks = \"<a style='padding-right:20px' href='https://\"+ msg.cid + \".daidemos.com/fwegsd?u=IBM' target='_blank'><img width='40px' height='40px' src='/static/img/conversation.svg'> Customer Page</a> <a style='padding-right:20px' href='https://\"+ msg.cid + \".daidemos.com/zfbcag?u=IBM' target='_blank'><img width='40px' height='40px' src='/static/img/agent.svg'> Agent Page</a> <a style='padding-right:20px' href='https://\"+ msg.cid + \".daidemos.com/sldncej?u=IBM' target='_blank'><img width='40px' height='40px' src='/static/img/briefcase.svg'> Watson@Work</a> <br><br><a style='padding-right:20px' href='https://\"+ msg.cid + \".daidemos.com/a/d/z/v/r?zz=\"+ msg.instJSON.companyEscape + \"' target='_blank'><img width='40px' height='40px' src='/static/img/nodered.png'>Node-Red (modify the UI's and webhooks)</a><a style='padding-right:20px' href='https://cloud.ibm.com/iam/users/invite_users' target='_blank'><svg focusable='false' preserveAspectRatio='xMidYMid meet' description='IAM UI Left nav' xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 32 32' aria-hidden='true' class='left-nav-header__icon'><path d='M24,14H22V8A6,6,0,0,0,10,8v6H8a2,2,0,0,0-2,2V28a2,2,0,0,0,2,2H24a2,2,0,0,0,2-2V16A2,2,0,0,0,24,14ZM12,8a4,4,0,0,1,8,0v6H12ZM24,28H8V16H24Z'></path></svg>Access Group</a> <a style='padding-right:20px' href='https://ibm.box.com/s/ci13fyhjaxokihc163paywne90y2104o' target='_blank'><img width='40px' height='40px' src='/static/img/video.svg'>Scripts, Videos, Decks</a>\";\n    else\n        msg.demolinks = \"<a style='padding-right:20px' href='https://\"+ msg.cid + \".daidemos.com/fwegsd?u=IBM' target='_blank'><img width='40px' height='40px' src='/static/img/conversation.svg'> Customer Page</a> <a style='padding-right:20px' href='https://\"+ msg.cid + \".daidemos.com/zfbcag?u=IBM' target='_blank'><img width='40px' height='40px' src='/static/img/agent.svg'> Agent Page</a> <a style='padding-right:20px' href='https://ibm.box.com/s/ci13fyhjaxokihc163paywne90y2104o' target='_blank'><img width='40px' height='40px' src='/static/img/video.svg'>Scripts, Videos, Decks</a> <br><br><a style='padding-right:20px' href='https://\"+ msg.cid + \".daidemos.com/a/d/z/v/r?zz=\"+ msg.instJSON.companyEscape + \"' target='_blank'><img width='40px' height='40px' src='/static/img/nodered.png'>Node-Red (modify the UI's and webhooks)</a><a style='padding-right:20px' href='https://cloud.ibm.com/iam/users/invite_users' target='_blank'><svg focusable='false' preserveAspectRatio='xMidYMid meet' description='IAM UI Left nav' xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 32 32' aria-hidden='true' class='left-nav-header__icon'><path d='M24,14H22V8A6,6,0,0,0,10,8v6H8a2,2,0,0,0-2,2V28a2,2,0,0,0,2,2H24a2,2,0,0,0,2-2V16A2,2,0,0,0,24,14ZM12,8a4,4,0,0,1,8,0v6H12ZM24,28H8V16H24Z'></path></svg>Access Group</a>\";\n}catch(fail){}\n\nmsg.provisionurl = \"https://cloud.ibm.com/schematics/workspaces/create?workspace_name=\" + msg.company + \"-DataAIDemoBuilder&repository=https://git.daidemos.com/git/\" + msg.script + \"&terraform_version=terraform_v0.13\";\nmsg.prov = \"<script type='text/javascript'> window.onbeforeunload = function() {return 'no'; } </script><p class='lead'>We'll be building an environment in your account, and pre-loading it with data from the website: <a href='\" + msg.url + \"' target='_blank'>\" + msg.url + \"</a> <span style='color:red; padding-left:10px;'><i class='fa fa-arrow-left' aria-hidden='true'></i> Ensure this is correct!</span><br><br> You can modify this url on the previous page under \\\"advanced options\\\". </p> </div> Click the link below, then click 'Create Workspace', and then click 'Apply Plan'.  Once your plan begins deploying, return here and follow along.  Do not deploy while any other of your instances are deleting, and do not reuse this link to re-provision.<br><center> <br> <a id='startTerraform' data-toggle='modal' data-target='#loginm' href='https://cloud.ibm.com/schematics/workspaces/create?workspace_name=\" + msg.company + \"-DataAIDemoBuilder&repository=https://git.daidemos.com/git/\" + msg.script + \"&terraform_version=terraform_v0.13' target='_blank'>Deploy to IBM Cloud<img src='/static/img/terraform-2d14a7d6b7.svg' style='padding-left:10px'></a> </center><br>\"\nif (msg.provisioned){\n    msg.htitle = \"Time to Demo!\";\n    msg.comp = msg.demolinks;\n    msg.prov = \"</div><p class='lead'>This instance is already deployed. To create another return to <a href='https://daidemos.com'>daidemos.com</a></p><br>\";\n}else if (msg.dupe){\n    msg.htitle = \"Welcome Back, eager demoer...\";\n    msg.comp = \"\";\n    msg.prov = \"</div><p class='lead'>There is already a running instance provisioned for this customer.  Maybe you're thinking \\\"it's broken, give me another!\\\"  Trust me, it's not, and in the odd chance it is - 99% odds a new instance will not fix the underlying issue.  <br><br>If you legitimately need to create the dupe, or want to find the owner of the instance hit up the slack channel for help, or if you are in a panic call or text me.  <br><br>-Garrett</p><br>\";\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1070,"y":80,"wires":[["a0849a.76e05368"]]},{"id":"8f3a2105.e728a8","type":"exec","z":"1c2d6e78.ff8e7a","command":"","addpay":true,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"configAssistant","x":880,"y":560,"wires":[[],[],[]]},{"id":"2463f156.6c41ae","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"msg2 = {};\nvar waid = msg.payload.p.replace(/:res.*/, \"\").replace(\"/\", \"~2F\") + \"/home\";\nmsg2.payload = \"(nice -n 15 node /root/configAssistant.js \\\"\" + msg.payload.i + \"\\\" \\\"\" + waid + \"\\\" > /root/scrape/\" + msg.payload.i + \"-WAinst.log 2>&1 ) &\";\nmsg2.topic = msg.payload.i;\nreturn msg2;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":560,"y":560,"wires":[["6227b2f1.a25294"]]},{"id":"5fb63300.ba699c","type":"template","z":"1c2d6e78.ff8e7a","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<head>\n<link rel=\"stylesheet\" type=\"text/css\" href=\"/static/css/bundle.s41.css\">\n<link rel=\"stylesheet\" href=\"https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css\">\n<link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css\" rel=\"stylesheet\" >\n<link rel=\"stylesheet\" href=\"https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css\">\n<link rel=\"stylesheet\" href=\"https://cdn.datatables.net/1.10.24/css/jquery.dataTables.min.css\">\n<script src=\"https://cdn.jsdelivr.net/npm/js-cookie@rc/dist/js.cookie.min.js\"></script>\n\n<title>D&AI Demos</title>\n<style>\n    .form-group{\n        margin-bottom:10px;\n    }\n    .clbutton{\n        position: fixed;\n        right: 10px;\n        bottom: 10px;\n    }\n    #statstext{\n        text-align: center;\n        font-weight: 300;\n    }\n    #sec10k{\n        font-size: small;\n    }\n    #myinst{\n        display:none;\n    }\n\n</style>\n</head>  \n<div class=\"container\" style=\"width: 70rem\">\n  <div class=\"row\">\n    <div class=\"col-12\">\n        <div class=\"jumbotron jumbotron-fluid\">\n            <h1 class=\"display-6\"><center>Data & AI DemoBuilder</center></h1>\n            <div id =\"statstext\"></div>\n            <br>\n            <p class=\"lead\">\n            <span style=\"color:red\">Before starting</span> ensure you have a \"Pay-As-You-Go\" or \"Subscription\" type IBM Cloud account. <a href=\"https://cloud.ibm.com/account/settings\" target=\"_blank\">Check Here</a><br> If this page says \"trial\", \"paas-only\", or \"upgrade account\" <span style=\"color:red\">anywhere on the page</span> you do not have the right account type, and must upgrade first and wait for your submitted upgrade to fully process.<span style=\"color: red;\"> If you ignore this note and continue with the wrong account type like {{slackers}} others, you'll waste at least 15 minutes of your time. So, pretty please - check your account.</span>\n            <br>\n            <br>\n            </p>\n            <form id=\"choosec\" class=\"\" action=\"/startProvision\" method=\"POST\">\n                <div class=\"mb-3\">\n                    <label for=\"fc1\">Company (Enter a real company name only, E.G. \"TD Bank\" or \"Walmart\". Spell and capitalize correctly - what you type here will be prominent!)</label>\n                    <input type=\"text\" class=\"form-control was-validated is-invalid\" name=\"company\" id=\"fc1\" placeholder=\"Enter a company name\" required>\n                    <div class=\"invalid-feedback\" id=\"vfeedback\">\n                    </div>\n                </div\n                \n                <br>\n                <div class=\"accordion accordion-flush\" id=\"ac1\">\n                  <div class=\"accordion-item\">\n                    <h2 class=\"accordion-header\" id=\"headingOne\">\n                      <button class=\"accordion-button collapsed\" type=\"button\" data-bs-toggle=\"collapse\" data-bs-target=\"#collapseOne\" aria-expanded=\"true\" aria-controls=\"collapseOne\">\n                        Advanced Options\n                      </button>\n                    </h2>\n                    <div id=\"collapseOne\" class=\"accordion-collapse collapse\" aria-labelledby=\"headingOne\" data-bs-parent=\"#accordionExample\">\n                      <div class=\"accordion-body\">\n                        \n                        <div class=\"form-group\">\n                            <label for=\"fcurl\"><span class=\"tconame\">Website</span> URL Override</label>\n                            <input type=\"url\" class=\"form-control was-validated\" name=\"url\" id=\"fcurl\" placeholder=\"https://mycompany.com/Page/For/Screenshot\" pattern=\"https*://.*\" required>\n                        </div>\n                        <div id=\"productlabel\" style=\"text-align: center;margin-top: 15px;\">Enter 3 products or services that <span class=\"tconame\">this company</span> sells or offers.</div>\n                        <div class=\"input-group mb-3\" id=\"productgroup\">\n                          <input type=\"search\" class=\"form-control\" name=\"product1\" id=\"product1\" placeholder=\"Inspyre Card\">\n                          <input type=\"search\" class=\"form-control\" name=\"product2\" id=\"product2\" placeholder=\"Argyle Sofa\">\n                          <input type=\"search\" class=\"form-control\" name=\"product3\" id=\"product3\" placeholder=\"Iphone 17 Super Max\">\n                        </div>\n                        <div class=\"mb-3\">\n                            <label for=\"faddr\"><span class=\"tconame\">Company</span> corporate address or closest location</label>\n                            <input type=\"input\" class=\"form-control was-validated\" name=\"address\" id=\"faddr\" placeholder=\"1212 River Glen Road, San Diego, CA 92010\" required>\n                        </div>\n\n                        <div class=\"form-group d-none\">\n                            <label for=\"fc2\">Demo</label>\n                            <select class=\"form-control\" name=\"demo\" id=\"fc2\" readonly>\n                              <option value=\"watson\">Watson Stack</option>\n                            </select>\n                        </div>\n                        <div class=\"form-group\">\n                            <label for=\"fc3\">Industry content to pre-load (All have general business dialogs)</label>\n                            <select class=\"form-control\" name=\"industry\" id=\"fc3\" readonly>\n                              <option value=\"Default\">Default</option>\n                              <option value=\"IVRvsChatbot\">IVR vs Chatbot</option>\n                              <option value=\"SelfService\">Banking Self-Service (beta, english language only)</option>\n                              <option value=\"HR\">Employee HR Self-Service (beta, english language only)</option>\n                              <option value=\"COVID\">COVID-19 (beta, english language only, soon to be depricated)</option>\n                            </select>\n                        </div>\n                        <div class=\"form-group\">\n                            <label for=\"dlang\">Language</label>\n                            <select class=\"form-control\" id=\"dlang\" name=\"language\" readonly>\n                              <option value=\"en\">English</option>\n                              <option value=\"es\">Spanish</option>\n                              <option value=\"pt\">Portuguese</option>\n                              <option value=\"de\">German</option>\n                              <option value=\"fi\">Finnish</option>\n                              <option value=\"fr\">French</option>\n                              <option value=\"ja\">Japanese</option>\n                            </select>\n                        </div>\n                        <div class=\"form-group\">\n                            <label for=\"sec10k\">SEC 10k (if wrong, modify the company name)</label>\n                            <a id=\"sec10k\" href=\"https://www.sec.gov/edgar/searchedgar/companysearch.html\" target=\"_blank\">Not found, will default to IBM's</a>\n                        </div>\n                        <div class=\"form-group\">\n                            <label for=\"aModelOR\">Override the audio model (Experts only!)</label>\n                            <input type=\"search\" class=\"form-control\" name=\"aModelOR\" id=\"aModelOR\" placeholder=\"en-US_ShortForm_NarrowbandModel\">\n                            <label for=\"aLangOR\">Override the TTS voice (Experts only!)</label>\n                            <input type=\"search\" class=\"form-control\" name=\"aLangOR\" id=\"aLangOR\" placeholder=\"en-US_EmilyV3Voice\">\n                        </div>\n                        <div class=\"form-group\">\n                            <label for=\"fc4\">Plan</label>\n                            <select class=\"form-control\" id=\"fc4\" name=\"plan\" readonly>\n                              <option value=\"plus_V2\">Plus/Premium/Advanced (IBMers use this one only)</option>\n                            </select>\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n                </div>\n                \n                \n                <br>\n                <input type=\"hidden\" id=\"uuid\" name=\"uuid\" value=\"{{req.query.uuid}}\"></input>\n                <button id=\"smb1\" type=\"submit\" class=\"btn btn-primary\" disabled >Continue</button>\n            </form>\n            \n    </div>\n  </div>\n</div>\n\n\n\n<div type=\"button\" class=\"btn btn-secondary clbutton\" data-bs-toggle=\"modal\" data-bs-target=\"#changeLog\">\n  Change Log\n</div>\n\n<div class=\"modal fade\" id=\"changeLog\" tabindex=\"-1\"  aria-hidden=\"true\">\n  <div class=\"modal-dialog\" style=\"max-width:90%;\">\n    <div class=\"modal-content\">\n      <div class=\"modal-header\">\n        <h5 class=\"modal-title\" id=\"exampleModalLabel\">Change Log</h5>\n        <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\" aria-label=\"Close\"></button>\n      </div>\n      <div class=\"modal-body\">\n         <table id=\"table\" style=\"width:100%;table-layout: fixed\"><thead>\n            <tr>\n                <th style=\"width:160px\">Date</th>\n                <th>Update</th>\n                <th style=\"width:50px;text-align:center;\">Link</th>\n            </tr>\n        </thead></table>\n\n      </div>\n    </div>\n  </div>\n</div>\n<div class=\"container\" style=\"width: 70rem\" id=\"myinst\">\n    <table id=\"otable\"><thead>\n    <tr>\n        <th>Company</th>\n        <th>Timestamp</th>\n        <th>Status</th>\n    </tr>\n</thead></table>\n</div>\n\n<script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js\" ></script>\n<script src=\"https://code.jquery.com/jquery-3.5.1.min.js\" integrity=\"sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=\" crossorigin=\"anonymous\"></script>\n<script src=\"https://code.jquery.com/ui/1.12.1/jquery-ui.min.js\" ></script>\n<script src=\"https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js\"></script>\n<script>\n\n$('#table').DataTable( {\n    ajax: {\n        url: '/cldata',\n        dataSrc: ''\n    },\n    autoWidth: false,\n    columns: [\n        { data: 'date', width: 160 },\n        { data: 'message' },\n        { data: 'url', width: 50 }\n    ],\n    order: [[ 0, \"desc\" ]]\n} );\n\n$(window).on('pageshow', function(){\n    $('#smb1').text(\"Continue\");\n    $('#smb1').prop('disabled', false);\n});\n\n$( \"#fc1\" ).change(function() {\n  $('#smb1').prop('disabled', true);\n  $('.tconame').text($( \"#fc1\" ).val());\n  $(\"#sec10k\").text(\"Searching...\");\n  $.get(\"/secData?company=\" + $( \"#fc1\" ).val(), function( data ) {\n  if(data == \"none\"){\n          $(\"#sec10k\").text(\"Not found, will default to IBM's\");\n          $(\"#sec10k\").attr(\"href\", \"https://www.sec.gov/edgar/searchedgar/companysearch.html\");\n      }else{\n        $(\"#sec10k\").attr(\"href\", data);\n        $(\"#sec10k\").text(data);\n      }\n}, \"text\");\n\n  $.post( \"/getWeb\", { name: $( \"#fc1\" ).val() })\n  .done(function( data ) {\n      if(data.website != null){\n        $( \"#fcurl\" ).val(data.website);\n        $( \"#faddr\" ).val(data.address);\n        $('#smb1').prop('disabled', false);\n        $(\"#vfeedback\").text(\"\");\n        $(\"#fc1\").switchClass( \"is-invalid\", \"is-valid\");\n        $(\"#fc1\")[0].setCustomValidity(\"\");\n      }else{\n          $(\"#fc1\")[0].setCustomValidity(\"fail\");\n          $(\"#vfeedback\").text(\"Never heard of them before... Please enter a website and location in 'Advanced Options', below.\");\n          $(\"#fc1\").switchClass( \"is-valid\", \"is-invalid\");\n      }\n    \n  });\n});\n$( \"#faddr\" ).change(function() {\n  $('#smb1').prop('disabled', false);\n  $(\"#fc1\")[0].setCustomValidity(\"\");\n  $(\"#fc1\").switchClass( \"is-valid\", \"is-invalid\");\n  $(\"#vfeedback\").text(\"\");\n});\n$( \"#fcurl\" ).change(function() {\n  $('#smb1').prop('disabled', false);\n  $(\"#fc1\")[0].setCustomValidity(\"\");\n  $(\"#fc1\").switchClass( \"is-valid\", \"is-invalid\");\n  $(\"#vfeedback\").text(\"\");\n});\n$('#choosec').submit(function(e){\n    $('#smb1').text(\"Searching for \" + $('#fc1').val().trim() + \"...\");\n    $('#smb1').prop('disabled', true);\n});\n$.get( \"/statstext\", function( data ) {\n  $( \"#statstext\" ).html( data[0].INSTANCES );\n});\n\nvar owner = Cookies.get(\"owner\");\nif (owner != undefined){\n    console.log(owner);\n    $(\".lead\").remove();\n    $(\"#myinst\").show();\n    $('#otable').DataTable( {\n        ajax: {\n            url: '/odata?o=' + owner,\n            dataSrc: ''\n        },\n        \"pageLength\": 5,\n        columns: [\n            { data: 'instance' },\n            { data: 'Timestamp' },\n            { data: 'provisioned' }\n        ],\n        order: [[ 1, \"desc\" ]]\n    } );\n}\n\n</script>","output":"str","x":1180,"y":40,"wires":[["5bfcecd3.14b81c"]]},{"id":"d40a489.6a67638","type":"delay","z":"1c2d6e78.ff8e7a","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":400,"y":560,"wires":[["2463f156.6c41ae"]]},{"id":"4b2356dc.f7dfc","type":"template","z":"1c2d6e78.ff8e7a","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"upstream us{{site}} {\n    server {{payload.p}}:443;\n    keepalive 10;\n}\nupstream us{{site}}zz {\n    server {{payload.p}}:3000;\n    keepalive 10;\n}\nupstream us{{site}}zzz {\n    server {{payload.p}}:3001;\n    keepalive 10;\n}\n\nserver {\n  listen 443 ssl;\n  server_name {{site}}.daidemos.com;\n  large_client_header_buffers 4 32k;\n\n  location / {\n    satisfy any;  \n    allow 127.0.0.1;\n    allow 150.238.89.98;\n    allow {{payload.p}};\n    auth_basic           \"Demo Area\";\n    auth_basic_user_file htcontrol;\n\n    proxy_pass https://us{{site}};\n    proxy_set_header Host $host;\n    proxy_set_header X-Real-IP $remote_addr;\n    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n    proxy_set_header X-Forwarded-Proto $scheme;\n    #proxy_read_timeout  36000s;\n    proxy_buffers 16 16k;\n    proxy_buffer_size 32k;\n    proxy_http_version 1.1;\n    proxy_set_header Upgrade $http_upgrade;\n    proxy_set_header Connection \"Upgrade\";\n  }\n  location /nadmin {\n    proxy_pass https://us{{site}};\n    proxy_set_header Host $host;\n    proxy_set_header X-Real-IP $remote_addr;\n    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n    proxy_set_header X-Forwarded-Proto $scheme;\n    #proxy_read_timeout  36000s;\n    proxy_buffers 16 16k;\n    proxy_buffer_size 32k;\n    proxy_http_version 1.1;\n    proxy_set_header Upgrade $http_upgrade;\n    proxy_set_header Connection \"Upgrade\";\n  }\n  location /translate {\n    proxy_pass https://us{{site}};\n    proxy_set_header Host $host;\n    proxy_set_header X-Real-IP $remote_addr;\n    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n    proxy_set_header X-Forwarded-Proto $scheme;\n    #proxy_read_timeout  36000s;\n    proxy_buffers 16 16k;\n    proxy_buffer_size 32k;\n    proxy_http_version 1.1;\n    proxy_set_header Upgrade $http_upgrade;\n    proxy_set_header Connection \"Upgrade\";\n  }\n}\nserver {\n  listen 443 ssl;\n  server_name {{site}}-target.daidemos.com;\n  large_client_header_buffers 4 32k;\n\n  location / {\n    satisfy any;  \n    allow 127.0.0.1;\n    allow 150.238.89.98;\n    allow 52.116.135.228;\n    auth_basic           \"Demo Area\";\n    auth_basic_user_file htcontrol;\n\n    proxy_pass http://us{{site}}zzz;\n    proxy_set_header Host $host;\n    proxy_set_header X-Real-IP $remote_addr;\n    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n    proxy_set_header X-Forwarded-Proto $scheme;\n    #proxy_read_timeout  36000s;\n    proxy_buffers 16 16k;\n    proxy_buffer_size 32k;\n    proxy_http_version 1.1;\n    proxy_set_header Upgrade $http_upgrade;\n    proxy_set_header Connection \"Upgrade\";\n  }\n}\nserver {\n  listen 3000 ssl;\n  server_name {{site}}.daidemos.com;\n  large_client_header_buffers 4 32k;\n\n  location / {\n    proxy_pass http://us{{site}}zz;\n    proxy_set_header Host $host;\n    proxy_set_header X-Real-IP $remote_addr;\n    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n    proxy_set_header X-Forwarded-Proto $scheme;\n    #proxy_read_timeout  36000s;\n    proxy_buffers 16 16k;\n    proxy_buffer_size 32k;\n    proxy_http_version 1.1;\n    proxy_set_header Upgrade $http_upgrade;\n    proxy_set_header Connection \"Upgrade\";\n  }\n}\nserver {\n  listen 443 ssl;\n  server_name ~^.*{{site}}.daidemos.com;\n  return 404;\n}","output":"str","x":660,"y":380,"wires":[["dc9f3443.61d3e"]]},{"id":"f74b2f9b.854bd8","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"\nmsg.filename = \"/etc/nginx/sites-enabled/\" + msg.payload.i;\nmsg.site = msg.payload.i.replace(/.*-/,\"\");\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":520,"y":380,"wires":[["4b2356dc.f7dfc","16e8995b.d23d2f"]]},{"id":"dc9f3443.61d3e","type":"file","z":"1c2d6e78.ff8e7a","name":"","filename":"","appendNewline":true,"createDir":false,"overwriteFile":"true","encoding":"none","x":810,"y":380,"wires":[["e4114bfb.d78f1"]]},{"id":"e4114bfb.d78f1","type":"exec","z":"1c2d6e78.ff8e7a","command":"service nginx reload","addpay":false,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"nginx","x":950,"y":380,"wires":[[],[],[]]},{"id":"fe991da3.ea5178","type":"http in","z":"1c2d6e78.ff8e7a","name":"","url":"/idestroy","method":"post","upload":false,"swaggerDoc":"","x":160,"y":440,"wires":[["c301b9fa.2ee74","ebe6c0b3.a29598","dd50272f.53152"]]},{"id":"21341df0.c8c992","type":"http in","z":"1c2d6e78.ff8e7a","name":"","url":"/icreate","method":"post","upload":false,"swaggerDoc":"","x":150,"y":400,"wires":[["c301b9fa.2ee74","f74b2f9b.854bd8"]]},{"id":"296fd1ba.2607ce","type":"http in","z":"1c2d6e78.ff8e7a","name":"","url":"/iassistant","method":"post","upload":false,"swaggerDoc":"","x":160,"y":560,"wires":[["c301b9fa.2ee74","d40a489.6a67638"]]},{"id":"2fe87e38.841772","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"try{\n    msg.payload = \"find /etc/nginx/sites-enabled/ -type f -iname '\" + msg.payload.i.match(/([^\\.][a-zA-Z0-9_]*-schematicbp\\w+)/i)[0] + \"' -delete\";\n}catch(fail){\n    msg.payload = \"find /etc/nginx/sites-enabled/ -type f -iname '\" + msg.payload.i + \"' -delete\";\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":660,"y":420,"wires":[["3de079ee.154aae"]]},{"id":"3de079ee.154aae","type":"exec","z":"1c2d6e78.ff8e7a","command":"","addpay":true,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"","x":810,"y":420,"wires":[["e4114bfb.d78f1"],[],[]]},{"id":"1ef0e6bb.de2759","type":"http in","z":"1c2d6e78.ff8e7a","name":"","url":"/ic/:instnum","method":"post","upload":true,"swaggerDoc":"","x":230,"y":780,"wires":[["4a3e0743.74ff2","62716d8a.28c23c"]]},{"id":"4a3e0743.74ff2","type":"json","z":"1c2d6e78.ff8e7a","name":"","property":"payload","action":"obj","pretty":true,"x":390,"y":780,"wires":[["6884243f.319be4"]]},{"id":"b8e791e.0091a7","type":"sqlite","z":"1c2d6e78.ff8e7a","mydb":"bb2f6fb4.d4be2","sqlquery":"msg.topic","sql":"","name":"","x":1140,"y":720,"wires":[[]]},{"id":"6884243f.319be4","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"msg.payload = Object.keys(msg.payload)[0];\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":540,"y":780,"wires":[["736915dc.8724b4"]]},{"id":"736915dc.8724b4","type":"json","z":"1c2d6e78.ff8e7a","name":"","property":"payload","action":"obj","pretty":true,"x":680,"y":780,"wires":[["4f6c6497.d15fa4","681fbf17.7f6f2","b61701b3.6a14c"]]},{"id":"4f6c6497.d15fa4","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"msg.topic = 'UPDATE \"demobuilder\" set \"account\" = \"'+ msg.payload.name + '\", \"owner\" = \"'+ msg.payload.owner +'\", \"account_id\" = \"'+ msg.payload.account_id+'\" where instance = \"'+ msg.req.params.instnum +'\"';\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":840,"y":780,"wires":[["73d48c8f.7a2014","46e7d604.1d7be","39f99d90.d0471a"]]},{"id":"c74571ec.13af08","type":"http in","z":"1c2d6e78.ff8e7a","name":"","url":"stats","method":"get","upload":false,"swaggerDoc":"","x":200,"y":1040,"wires":[["aec00c69.ed7f38"]]},{"id":"62716d8a.28c23c","type":"http response","z":"1c2d6e78.ff8e7a","name":"","statusCode":"","headers":{},"x":850,"y":920,"wires":[]},{"id":"76ce03cb.c6af74","type":"sqlite","z":"1c2d6e78.ff8e7a","mydb":"bb2f6fb4.d4be2","sqlquery":"msg.topic","sql":"select d.account, d.owner, d.instance, d.Timestamp, p.provisioned from demobuilder d left join provisioned p on d.instance = p.instance;","name":"","x":600,"y":1000,"wires":[["a5169e5b.91a1a8"]]},{"id":"1e7ee0cd.6fb99f","type":"template","z":"1c2d6e78.ff8e7a","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<head>\n<link rel=\"stylesheet\" type=\"text/css\" href=\"/static/css/bundle.s41.css\">\n<link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css\" rel=\"stylesheet\" integrity=\"sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1\" crossorigin=\"anonymous\">\n<link rel=\"stylesheet\" href=\"https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css\">\n<link rel=\"stylesheet\" href=\"https://cdn.datatables.net/1.10.24/css/jquery.dataTables.min.css\">\n<title>DemoBuilder Stats</title></head>  \n<body>\n<div class=\"container\" style=\"padding:10px\">\n  <div class=\"row\">\n    <div class=\"col-sm\">\n        <div class=\"card\">\n          <div class=\"card-body\">\n            <h5 class=\"card-title\">Users</h5>\n            <p id=\"usercount\" class=\"card-text\"></p>\n          </div>\n        </div>\n    </div>\n    <div class=\"col-sm\">\n        <div class=\"card\">\n          <div class=\"card-body\">\n            <h5 class=\"card-title\">Total Instances</h5>\n            <p id=\"instancecount\" class=\"card-text\"></p>\n          </div>\n        </div>\n    </div>\n    <div class=\"col-sm\">\n        <div class=\"card\">\n          <div class=\"card-body\">\n            <h5 class=\"card-title\">Active Instances</h5>\n            <p id=\"activecount\" class=\"card-text\"></p>\n          </div>\n        </div>\n    </div>\n    </div><div class=\"row\">\n    </div>\n</div>\n    <table id=\"table\"><thead>\n            <tr>\n                <th>Account</th>\n                <th>Owner</th>\n                <th>Company</th>\n                <th>Timestamp</th>\n                <th>Status</th>\n            </tr>\n        </thead></table>\n\n</body>\n\n\n<script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js\" integrity=\"sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW\" crossorigin=\"anonymous\"></script>\n<script src=\"https://code.jquery.com/jquery-3.5.1.min.js\" integrity=\"sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=\" crossorigin=\"anonymous\"></script>\n<script src=\"../../socket.io/socket.io.js\"></script>\n<script src=\"https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js\"></script>\n<script>\n$('#table').DataTable( {\n    ajax: {\n        url: '/statsdata{{{super}}}',\n        dataSrc: ''\n    },\n    columns: [\n        { data: 'account' },\n        { data: 'owner' },\n        { data: 'instance' },\n        { data: 'Timestamp' },\n        { data: 'provisioned' }\n    ],\n    order: [[ 3, \"desc\" ]]\n} );\n$.get( \"/usercount\", function( data ) {\n  $( \"#usercount\" ).html( data[0].USERS );\n});\n$.get( \"/instancecount\", function( data ) {\n  $( \"#instancecount\" ).html( data[0].INSTANCES );\n});\n$.get( \"/activecount\", function( data ) {\n  $( \"#activecount\" ).html( data[0].INSTANCES );\n});\n\n    \n</script>","output":"str","x":600,"y":1040,"wires":[["62716d8a.28c23c"]]},{"id":"6854f16b.75ddd8","type":"http in","z":"1c2d6e78.ff8e7a","name":"","url":"statsdata","method":"get","upload":false,"swaggerDoc":"","x":220,"y":1000,"wires":[["28a7b141.a2d8c6"]]},{"id":"c33a3905.ead248","type":"sqlite","z":"1c2d6e78.ff8e7a","mydb":"bb2f6fb4.d4be2","sqlquery":"msg.topic","sql":"","name":"DB","x":1370,"y":360,"wires":[[]]},{"id":"16e8995b.d23d2f","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"msg.topic = 'INSERT INTO \"main\".\"provisioned\"(\"instance\",\"provisioned\") VALUES (\"'+ msg.payload.i + '\",\"Active\")';\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1080,"y":360,"wires":[["c33a3905.ead248"]]},{"id":"b9686877.14b838","type":"http in","z":"1c2d6e78.ff8e7a","name":"","url":"smsHook","method":"post","upload":false,"swaggerDoc":"","x":220,"y":1100,"wires":[["62716d8a.28c23c","60d7899.6278578"]]},{"id":"60d7899.6278578","type":"mqtt out","z":"1c2d6e78.ff8e7a","name":"","topic":"texts","qos":"2","retain":"","broker":"18c5ccd5.ef404b","x":410,"y":1100,"wires":[]},{"id":"7e7e834b.898e24","type":"sqlite","z":"1c2d6e78.ff8e7a","mydb":"bb2f6fb4.d4be2","sqlquery":"msg.topic","sql":"","name":"p","x":390,"y":80,"wires":[["581e7492.704834"]]},{"id":"581e7492.704834","type":"function","z":"1c2d6e78.ff8e7a","name":"r","func":"msg.comp = \"\";\nmsg.htitle = \"Data & AI DemoBuilder\";\nmsg.provisioned = false;\ntry{\n    if (msg.payload[0].provisioned === \"Active\"){\n        msg.provisioned = true;\n    }\n}\ncatch(fail){}\n\nmsg.topic = \"select script, json from tfscript t where t.instance like '\" + msg.cid + \"' or t.instance like '\" + msg.company + \"-\" + msg.cid + \"'\";\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":510,"y":80,"wires":[["caa53678.6aaa08"]]},{"id":"fc3d98ad.e4c0a8","type":"sqlite","z":"1c2d6e78.ff8e7a","mydb":"bb2f6fb4.d4be2","sqlquery":"fixed","sql":"select COUNT(DISTINCT d.owner) as \"USERS\"  from demobuilder d left join provisioned p on d.instance = p.instance;","name":"","x":440,"y":920,"wires":[["62716d8a.28c23c"]]},{"id":"87bd455e.78d9e","type":"http in","z":"1c2d6e78.ff8e7a","name":"","url":"usercount","method":"get","upload":false,"swaggerDoc":"","x":220,"y":920,"wires":[["fc3d98ad.e4c0a8"]]},{"id":"880b4f4d.7a5038","type":"sqlite","z":"1c2d6e78.ff8e7a","mydb":"bb2f6fb4.d4be2","sqlquery":"fixed","sql":"select COUNT(DISTINCT d.instance) as \"INSTANCES\"  from demobuilder d left join provisioned p on d.instance = p.instance;","name":"","x":440,"y":880,"wires":[["62716d8a.28c23c"]]},{"id":"3292fc4.4589a84","type":"http in","z":"1c2d6e78.ff8e7a","name":"","url":"instancecount","method":"get","upload":false,"swaggerDoc":"","x":230,"y":880,"wires":[["880b4f4d.7a5038"]]},{"id":"aec00c69.ed7f38","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"msg.super = \"\";\ntry{\n    if (msg.payload.u == \"garrett\"){\n        msg.super = \"?u=garrett\";\n        return [msg,null];\n    }\n    else if (msg.payload.p != undefined){\n        msg.super = \"?p=\" + msg.payload.p;\n        return [msg,null];\n    }\n    else\n        return [null,msg];\n}catch(fail){}\n","outputs":2,"noerr":0,"initialize":"","finalize":"","x":400,"y":1040,"wires":[["1e7ee0cd.6fb99f"],["bc2bed8c.11cf6"]]},{"id":"28a7b141.a2d8c6","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"msg.super = \"\";\ntry{\n    if (msg.payload.u == \"garrett\"){\n        msg.super = \"?u=garrett\";\n        msg.garrett = true\n        msg.topic = \"select max(t.json) as json, max(d.account) as account, max(d.owner) as owner,  max(d.Timestamp) as Timestamp, '<a href=\\\"\\' || t.instance || '-WAinst.log\\\" target=\\\"_blank\\\">' || max(p.provisioned) || '</a>' as provisioned from tfscript t left join provisioned p on t.instance = p.instance left join demobuilder d  on t.instance = d.instance group by t.instance;\";\n        return msg;\n    }\n    else if (msg.payload.p != undefined){\n        msg.super = \"?p=\" + msg.payload.p;\n        msg.topic = \"select max(t.json) as json, SUBSTR(max(d.account), 1, 3) || '*********' as account, SUBSTR(max(d.owner), 1, 4) || '********' as owner, d.Timestamp, p.provisioned from tfscript t left join provisioned p on t.instance = p.instance left join demobuilder d  on t.instance = d.instance group by t.instance;\";\n        return msg;\n    }\n}catch(fail){}\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":400,"y":1000,"wires":[["76ce03cb.c6af74"]]},{"id":"117fdd94.3a24a2","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"msg.topic = 'UPDATE \"main\".\"provisioned\" SET \"provisioned\" = \"Decommissioned\" where \"instance\" LIKE \"'+ msg.payload + '\";';\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":820,"y":460,"wires":[["c33a3905.ead248"]]},{"id":"9d78640f.59d8d8","type":"inject","z":"1c2d6e78.ff8e7a","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1220,"y":560,"wires":[["8f7ca9cf.60e5b"]]},{"id":"8f7ca9cf.60e5b","type":"exec","z":"1c2d6e78.ff8e7a","command":"ls /etc/nginx/sites-enabled/","addpay":false,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"","x":1420,"y":560,"wires":[["f155898c.3bee8"],[],[]]},{"id":"f155898c.3bee8","type":"split","z":"1c2d6e78.ff8e7a","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1630,"y":560,"wires":[["9176e563.6b362"]]},{"id":"9176e563.6b362","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"msg.topic = 'UPDATE \"main\".\"provisioned\" SET \"provisioned\" = \"Active\" where \"instance\" = \"'+ msg.payload + '\";';\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1860,"y":560,"wires":[["c33a3905.ead248"]]},{"id":"ab48c1cd.6ca08","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"msg.topic = 'UPDATE \"main\".\"provisioned\" SET \"provisioned\" = \"Decommissioned\" where \"provisioned\" = \"Active\";';\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1780,"y":520,"wires":[["c33a3905.ead248"]]},{"id":"f249b367.afd5b8","type":"http in","z":"1c2d6e78.ff8e7a","name":"","url":"activecount","method":"get","upload":false,"swaggerDoc":"","x":220,"y":840,"wires":[["a0a0eaae.9b3b38"]]},{"id":"a0a0eaae.9b3b38","type":"sqlite","z":"1c2d6e78.ff8e7a","mydb":"bb2f6fb4.d4be2","sqlquery":"fixed","sql":"select COUNT(DISTINCT d.instance) as \"INSTANCES\"  from demobuilder d left join provisioned p on d.instance = p.instance where p.provisioned = \"Active\";","name":"","x":440,"y":840,"wires":[["62716d8a.28c23c"]]},{"id":"704e9d12.2ef6a4","type":"inject","z":"1c2d6e78.ff8e7a","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1620,"y":520,"wires":[["ab48c1cd.6ca08"]]},{"id":"b809cf8e.2d53c8","type":"http request","z":"1c2d6e78.ff8e7a","name":"","method":"GET","ret":"obj","paytoqs":"ignore","url":"https://api.github.com/repos/garrettrowe/watsonAutomation/git/trees/main?recursive=true","tls":"","persist":false,"proxy":"","authType":"","x":2330,"y":140,"wires":[["4605fb77.bd0b04"]]},{"id":"9882b1d6.9cece8","type":"change","z":"1c2d6e78.ff8e7a","name":"","rules":[{"t":"set","p":"headers","pt":"msg","to":"{\"Accept\":\"application/vnd.github.v3+json\",\"User-Agent\":\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:78.0) Gecko/20100101 Firefox/78.0\"}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":2130,"y":140,"wires":[[]]},{"id":"4605fb77.bd0b04","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"var demos = \"\";\nmsg.payload.tree.forEach(function(item) {\n  if (item.path.search(\"demos/watson/assistant_\") == 0){\n    var d = item.path.replace(/demos\\/watson\\/assistant_/,\"\").replace(\".json\",\"\");\n    demos = demos + '<option value=\"' + d + '\">' + d + '</option>';\n  }\n});\n\nflow.set(\"demos\", demos);\nmsg.demos = demos;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2500,"y":140,"wires":[[]]},{"id":"1cd0da82.3c0b55","type":"http in","z":"1c2d6e78.ff8e7a","name":"","url":"/repoUpdate","method":"post","upload":false,"swaggerDoc":"","x":1910,"y":140,"wires":[["9882b1d6.9cece8","4a75d7e.938c7a8"]]},{"id":"4a75d7e.938c7a8","type":"http response","z":"1c2d6e78.ff8e7a","name":"","statusCode":"","headers":{},"x":2110,"y":100,"wires":[]},{"id":"412c1220.4e1514","type":"start-up-trigger","z":"1c2d6e78.ff8e7a","x":1880,"y":100,"wires":[["9882b1d6.9cece8","f628a536.151bf","e0f21e8a.2e6a48"]]},{"id":"9eb7ef5c.f9a988","type":"inject","z":"1c2d6e78.ff8e7a","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1900,"y":60,"wires":[["9882b1d6.9cece8","e0f21e8a.2e6a48"]]},{"id":"c09e641d.9f134","type":"change","z":"1c2d6e78.ff8e7a","name":"","rules":[{"t":"set","p":"demos","pt":"msg","to":"demos","tot":"flow"}],"action":"","property":"","from":"","to":"","reg":false,"x":540,"y":40,"wires":[["7c83be15.59d7a"]]},{"id":"aaf54b22.9752c","type":"http in","z":"1c2d6e78.ff8e7a","name":"","url":"/softDestroy","method":"post","upload":false,"swaggerDoc":"","x":170,"y":480,"wires":[["c301b9fa.2ee74"]]},{"id":"ebe6c0b3.a29598","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"try{\n    msg.payload = JSON.parse(msg.payload.i)[0].replace(/schematics.*workspace\\./,\"\").replace(/\\..*/,\"\");\n}catch(fail){\n    msg.payload = msg.payload.i;\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":660,"y":460,"wires":[["117fdd94.3a24a2"]]},{"id":"aaf3bc53.f4b608","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"msg.url = \"https://\" + msg.payload.Instance + \".daidemos.com/destroy\"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":520,"y":500,"wires":[["42fe5ac1.904c14"]]},{"id":"42fe5ac1.904c14","type":"http request","z":"1c2d6e78.ff8e7a","name":"","method":"DELETE","ret":"txt","paytoqs":"ignore","url":"","tls":"2b836cd.3aa9214","persist":true,"proxy":"","authType":"","x":670,"y":500,"wires":[[]]},{"id":"dd50272f.53152","type":"delay","z":"1c2d6e78.ff8e7a","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":500,"y":420,"wires":[["2fe87e38.841772"]]},{"id":"6938bb72.6f8df4","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"msg.payload.Ip = msg.payload.Ip.match(/requestID=.* .*DataAIDemoBuilder\\.[A-z0-9]*/,\"\").replace(/requestID=/,\"\");\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":520,"y":340,"wires":[["a20bb6d1.7fd53"]]},{"id":"a20bb6d1.7fd53","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"msg.topic = 'INSERT INTO \"main\".\"wksp\"(\"inst\",\"wksp\") VALUES (\"'+ msg.payload.Instance + '\",\"'+ msg.payload.Ip + '\")';\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":720,"y":340,"wires":[["c33a3905.ead248"]]},{"id":"6600c913.83217","type":"template","z":"1c2d6e78.ff8e7a","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"terraform {\n  required_providers {\n    ibm = {\n      source = \"IBM-Cloud/ibm\"\n      version = \"~> 1.21.0\"\n    }\n    logship = {\n      source = \"garrettrowe/logship\"\n      version = \"~> 0.0.4\"\n    }\n    sshkey = {\n      source = \"garrettrowe/sshkey\"\n      version = \"~> 0.3.0\"\n    }\n  }\n}\nprovider \"logship\" {\n}\nprovider \"ibm\" {\n  generation         = 2\n  region             = \"us-south\"\n}\nprovider \"sshkey\" {\n  generation         = 2\n  region             = \"us-south\"\n}\ndata \"local_file\" \"configs\" {\n  filename = join(\"\", [\"../\", sort(fileset(\"../\", \"job-log*\"))[0]])\n}\n\nlocals {\n    company = \"{{companyEscape}}\"\n    plan = \"{{plan}}\"\n    companysafe = \"{{companySafe}}\"\n}\n\ndata \"logship\" \"startlog\" {\n  log = \"Starting Terraform\"\n  instance = \"{{instance}}\"\n  ip = data.local_file.configs.content\n}\n\nresource \"ibm_iam_service_id\" \"serviceID\" {\n  name = \"{{{resourceGroup}}}\"\n}\nresource \"ibm_iam_service_api_key\" \"automationkey\" {\n  name = \"{{{resourceGroup}}}\"\n  iam_service_id = ibm_iam_service_id.serviceID.iam_id\n}\nresource \"ibm_iam_access_group\" \"accgrp\" {\n  name        = \"{{{resourceGroup}}}\"\n  description = \"${local.company} access group\"\n}\nresource \"ibm_iam_access_group_members\" \"accgroupmem\" {\n  access_group_id = ibm_iam_access_group.accgrp.id\n  iam_service_ids = [ibm_iam_service_id.serviceID.id]\n}\nresource \"ibm_resource_group\" \"group\" {\n  name = \"{{{resourceGroup}}}\"\n}\ndata \"logship\" \"grouplog\" {\n  log = \"Created Resource Group: ${ibm_resource_group.group.id}\"\n  instance = \"{{instance}}\"\n  ip = \"resourcegroup\"\n}\n\nresource \"ibm_iam_access_group_policy\" \"policy\" {\n  access_group_id = ibm_iam_access_group.accgrp.id\n  roles        = [\"Operator\", \"Writer\", \"Reader\", \"Viewer\", \"Editor\", \"Administrator\", \"Manager\"]\n  resources {\n    resource_group_id = ibm_resource_group.group.id\n  }\n}\nresource \"ibm_iam_access_group_policy\" \"policya\" {\n  access_group_id = ibm_iam_access_group.accgrp.id\n  roles        = [\"Viewer\"]\n  account_management = true\n  provisioner \"local-exec\" { \n    command = \"ibmcloud login -q --apikey ${ibm_iam_service_api_key.automationkey.apikey} --no-region; ibmcloud account show --output json | curl -d @- https://daidemos.com/ic/{{instance}}\"\n  }\n}\nresource \"ibm_iam_user_invite\" \"invite_user\" {\n    users = [\"automation@daidemos.com\"]\n    access_groups = [ibm_iam_access_group.accgrp.id]\n}\n\nresource \"ibm_resource_instance\" \"lt_instance\" {\n  name              = \"{{{resourceGroup}}}-translator\"\n  service           = \"language-translator\"\n  plan              = local.plan != \"plus\" ? \"lite\" : \"standard\"\n  location          = \"us-south\"\n  resource_group_id = ibm_resource_group.group.id\n\n  timeouts {\n    create = \"15m\"\n    update = \"15m\"\n    delete = \"15m\"\n  }\n}\nresource \"ibm_resource_key\" \"lt_key\" {\n  name                 = \"${ibm_resource_instance.lt_instance.name}-key\"\n  role                 = \"Manager\"\n  resource_instance_id = ibm_resource_instance.lt_instance.id\n  \n  timeouts {\n    create = \"15m\"\n    delete = \"15m\"\n  }\n}\ndata \"logship\" \"ltlog\" {\n  log = \"Created Watson Language Translator: ${ibm_resource_instance.lt_instance.name}\"\n  instance = \"{{instance}}\"\n}\n\nresource \"ibm_resource_instance\" \"discovery_instance\" {\n  name              = \"{{{resourceGroup}}}-discovery\"\n  service           = \"discovery\"\n  plan              = \"{{discovery}}\"\n  location          = \"us-south\"\n  resource_group_id = ibm_resource_group.group.id\n\n  timeouts {\n    create = \"15m\"\n    update = \"15m\"\n    delete = \"15m\"\n  }\n}\nresource \"ibm_resource_key\" \"discovery_key\" {\n  name                 = \"${ibm_resource_instance.discovery_instance.name}-key\"\n  role                 = \"Manager\"\n  resource_instance_id = ibm_resource_instance.discovery_instance.id\n  \n  timeouts {\n    create = \"15m\"\n    delete = \"15m\"\n  }\n}\ndata \"logship\" \"discoverylog\" {\n  log = \"Created Watson Discovery: ${ibm_resource_instance.discovery_instance.name}\"\n  instance = \"{{instance}}\"\n}\n\nresource \"ibm_resource_instance\" \"stt_instance\" {\n  name              = \"{{{resourceGroup}}}-stt\"\n  service           = \"speech-to-text\"\n  plan              = local.plan != \"plus\" ? \"lite\" : \"plus\"\n  location          = \"us-south\"\n  resource_group_id = ibm_resource_group.group.id\n\n  timeouts {\n    create = \"15m\"\n    update = \"15m\"\n    delete = \"15m\"\n  }\n}\nresource \"ibm_resource_key\" \"stt_key\" {\n  name                 = \"${ibm_resource_instance.stt_instance.name}-key\"\n  role                 = \"Manager\"\n  resource_instance_id = ibm_resource_instance.stt_instance.id\n  \n  timeouts {\n    create = \"15m\"\n    delete = \"15m\"\n  }\n}\ndata \"logship\" \"sttlog\" {\n  log = \"Created Speech-to-text: ${ibm_resource_instance.stt_instance.name}\"\n  instance = \"{{{instance}}}\"\n}\n\nresource \"ibm_resource_instance\" \"tts_instance\" {\n  name              = \"{{{resourceGroup}}}-tts\"\n  service           = \"text-to-speech\"\n  plan              = local.plan != \"plus\" ? \"lite\" : \"standard\"\n  location          = \"us-south\"\n  resource_group_id = ibm_resource_group.group.id\n\n  timeouts {\n    create = \"15m\"\n    update = \"15m\"\n    delete = \"15m\"\n  }\n}\nresource \"ibm_resource_key\" \"tts_key\" {\n  name                 = \"${ibm_resource_instance.tts_instance.name}-key\"\n  role                 = \"Manager\"\n  resource_instance_id = ibm_resource_instance.tts_instance.id\n  \n  timeouts {\n    create = \"15m\"\n    delete = \"15m\"\n  }\n}\ndata \"logship\" \"ttslog\" {\n  log = \"Created Text-to-speech: ${ibm_resource_instance.tts_instance.name}\"\n  instance = \"{{instance}}\"\n}\n\nresource \"ibm_resource_instance\" \"cognos_instance\" {\n  name              = \"{{{resourceGroup}}}-cognos\"\n  service           = \"dynamic-dashboard-embedded\"\n  plan              = local.plan != \"plus\" ? \"lite\" : \"paygo\"\n  location          = \"us-south\"\n  resource_group_id = ibm_resource_group.group.id\n\n  timeouts {\n    create = \"15m\"\n    update = \"15m\"\n    delete = \"15m\"\n  }\n}\nresource \"ibm_resource_key\" \"cognos_key\" {\n  name                 = \"${ibm_resource_instance.cognos_instance.name}-key\"\n  role                 = \"Manager\"\n  resource_instance_id = ibm_resource_instance.cognos_instance.id\n  \n  timeouts {\n    create = \"15m\"\n    delete = \"15m\"\n  }\n}\ndata \"logship\" \"cognoslog\" {\n  log = \"Created Cognos Dashboard: ${ibm_resource_instance.cognos_instance.name}\"\n  instance = \"{{instance}}\"\n}\n\nresource \"ibm_resource_instance\" \"wml_instance\" {\n  name              = \"{{{resourceGroup}}}-wml\"\n  service           = \"pm-20\"\n  plan              = local.plan != \"plus\" ? \"lite\" : \"v2-standard\"\n  location          = \"us-south\"\n  resource_group_id = ibm_resource_group.group.id\n\n  timeouts {\n    create = \"15m\"\n    update = \"15m\"\n    delete = \"15m\"\n  }\n}\nresource \"ibm_resource_instance\" \"dsx_instance\" {\n  name              = \"{{{resourceGroup}}}-dsx\"\n  service           = \"data-science-experience\"\n  plan              = local.plan != \"plus\" ? \"free-v1\" : \"standard-v1\"\n  location          = \"us-south\"\n  resource_group_id = ibm_resource_group.group.id\n\n  timeouts {\n    create = \"15m\"\n    update = \"15m\"\n    delete = \"15m\"\n  }\n}\nresource \"ibm_resource_instance\" \"cos_instance\" {\n  name              = \"{{{resourceGroup}}}-cos\"\n  service           = \"cloud-object-storage\"\n  plan              = local.plan != \"plus\" ? \"lite\" : \"standard\"\n  location          = \"global\"\n  resource_group_id = ibm_resource_group.group.id\n\n  timeouts {\n    create = \"15m\"\n    update = \"15m\"\n    delete = \"15m\"\n  }\n}\n\ndata \"logship\" \"wmllog\" {\n  log = \"Created Watson Machine Learning: ${ibm_resource_instance.wml_instance.name}\"\n  instance = \"{{instance}}\"\n}\n\nresource \"ibm_resource_instance\" \"nlu_instance\" {\n  name              = \"{{{resourceGroup}}}-nlu\"\n  service           = \"natural-language-understanding\"\n  plan              = local.plan != \"plus\" ? \"free\" : \"standard\"\n  location          = \"us-south\"\n  resource_group_id = ibm_resource_group.group.id\n\n  timeouts {\n    create = \"15m\"\n    update = \"15m\"\n    delete = \"15m\"\n  }\n}\nresource \"ibm_resource_key\" \"nlu_key\" {\n  name                 = \"${ibm_resource_instance.nlu_instance.name}-key\"\n  role                 = \"Manager\"\n  resource_instance_id = ibm_resource_instance.nlu_instance.id\n  \n  timeouts {\n    create = \"15m\"\n    delete = \"15m\"\n  }\n}\ndata \"logship\" \"nlulog\" {\n  log = \"Created Watson NLU: ${ibm_resource_instance.nlu_instance.name}\"\n  instance = \"{{instance}}\"\n}\n\nresource \"ibm_resource_instance\" \"wa_instance\" {\n  name              = \"{{{resourceGroup}}}-assistant\"\n  service           = \"conversation\"\n  plan              = local.plan != \"plus\" ? \"lite\" : \"plus\"\n  location          = \"us-south\"\n  resource_group_id = ibm_resource_group.group.id\n  \n  provisioner \"local-exec\" {\n    command    = \"curl -d 'i={{instance}}&p=${self.id}' -X POST https://daidemos.com/iassistant\"\n  }\n\n  timeouts {\n    create = \"15m\"\n    update = \"15m\"\n    delete = \"15m\"\n  }\n}\nresource \"ibm_resource_key\" \"wa_key\" {\n  name                 = \"${ibm_resource_instance.wa_instance.name}-key\"\n  role                 = \"Manager\"\n  resource_instance_id = ibm_resource_instance.wa_instance.id\n  timeouts {\n    create = \"15m\"\n    delete = \"15m\"\n  }\n}\n\ndata \"logship\" \"walog\" {\n  log = \"Created Watson Assistant: ${ibm_resource_instance.wa_instance.name}\"\n  ip = ibm_resource_instance.wa_instance.id\n  instance = \"{{instance}}\"\n}\n\nresource \"ibm_is_vpc\" \"testacc_vpc\" {\n  name = \"{{{resourceGroup}}}-vpc\"\n  resource_group = ibm_resource_group.group.id\n}\ndata \"logship\" \"vpclog\" {\n  log = \"Created VPC: ${ibm_is_vpc.testacc_vpc.name}\"\n  instance = \"{{instance}}\"\n}\n\nresource \"ibm_is_subnet\" \"testacc_subnet\" {\n  name            = \"{{{resourceGroup}}}-subnet\"\n  vpc             = ibm_is_vpc.testacc_vpc.id\n  resource_group  = ibm_resource_group.group.id\n  zone            = \"us-south-1\"\n  ipv4_cidr_block = \"{{{cidr}}}\"\n  public_gateway  = ibm_is_public_gateway.publicgateway1.id\n}\ndata \"logship\" \"subnetlog\" {\n  log = \"Created Subnet: ${ibm_is_subnet.testacc_subnet.name}\"\n  instance = \"{{instance}}\"\n}\n  \nresource \"ibm_is_public_gateway\" \"publicgateway1\" {\n  name = \"{{{resourceGroup}}}-gateway\"\n  vpc  = ibm_is_vpc.testacc_vpc.id\n  zone = \"us-south-1\"\n  resource_group = ibm_resource_group.group.id\n}\ndata \"logship\" \"gatewaylog\" {\n  log = \"Created Gateway: ${ibm_is_public_gateway.publicgateway1.name}\"\n  instance = \"{{instance}}\"\n}\n\nresource \"sshkey\" \"testacc_sshkey\" {\n  name       = \"automationmanager\"\n  resource_group = ibm_resource_group.group.id\n  public_key = \"ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDBtG5XWo4SkYH6AxNI536z2O3IPznhURL1EYiYwKLbJhjJdEYme7TWucgStHrCcNriiT021Rjq85iL/Imqu9/knNSWMBwZtPLEi5PmnOFHeNlYcVEGhhiuAHN47LPn9+ycQhIc6ECJEGvmbQZeDxLkYu/Ky2xsIFH+71iuanonmlEWDyesEv3b5ev8ELu/pp3z997eqtiD5TqIxA5SxLinZ8dA71UAjE8uemPunqPDhY2K9tHzRawkswckPywNs/ARUmdoAko+DKrJ9VooYPz/NY0Tguy7u3Lend+d8/Mt3snyLc4b5VEPe3O0G2/CVIzNfXAbhrhlTgr8UfoxrDpYtCfn/Hf2GQPpORgqj99SHKXU+1lb4D5vyc7TTMAhksToDpcw4w22jJGLrYZ8yvrKGvCWlgZASyvMrpwInwMN9Lt+rJkzyX2jyc9ATQuGDJpshObEDBRkknpaCMdw0iwcmZYAlcHxV1j9doiBKugMjN6q1Xv5cWEi5h8gOGOzVKO+flltjkcKEceMFJhpD3E8LWm8f0d3khSbpyjjfhiCj7S7iyWBcSmzVbPOC7ObcHZq4RcpwdP3mfzjh1RGl0sGUhcvZL2uMmIutNZkPGcWLpDSY67M6reE7Wst6AMeOPERay2FXeHc+kPoMcNLiiizwwNdxL9q54B8sItYCxvv9Q== automationmanager\"\n}\n\n\nresource \"ibm_is_instance\" \"testacc_instance\" {\n  name    = \"{{{resourceGroup}}}-vsi\"\n  image   = \"r006-ed3f775f-ad7e-4e37-ae62-7199b4988b00\"\n  profile = \"bx2-4x16\"\n  resource_group = ibm_resource_group.group.id\n\n  primary_network_interface {\n    subnet = ibm_is_subnet.testacc_subnet.id\n  }\n\n  vpc       = ibm_is_vpc.testacc_vpc.id\n  zone      = \"us-south-1\"\n  keys      = [sshkey.testacc_sshkey.id]\n  user_data = <<EOT\n#cloud-config\nwrite_files:\n - content: |\n    ${jsonencode(ibm_resource_key.wa_key.credentials)}\n   path: /root/watsonassistant.txt\n - content: |\n    ${jsonencode(ibm_resource_key.discovery_key.credentials)}\n   path: /root/watsondiscovery.txt\n - content: |\n    ${jsonencode(ibm_resource_instance.wa_instance)}\n   path: /root/watsonassistantInst.txt\n - content: |\n    ${jsonencode(ibm_resource_instance.discovery_instance)}\n   path: /root/watsondiscoveryInst.txt\n - content: |\n    ${jsonencode(ibm_resource_key.lt_key.credentials)}\n   path: /root/wlt.txt\n - content: |\n    ${jsonencode(ibm_resource_key.stt_key.credentials)}\n   path: /root/wstt.txt\n - content: |\n    ${jsonencode(ibm_resource_key.tts_key.credentials)}\n   path: /root/wtts.txt\n - content: |\n    ${jsonencode(ibm_resource_key.cognos_key.credentials)}\n   path: /root/cognos.txt\n - content: |\n    ${jsonencode(ibm_iam_service_api_key.automationkey)}\n   path: /root/automationkey.txt\n - content: |\n    ${jsonencode(ibm_resource_key.nlu_key.credentials)}\n   path: /root/nlu.txt\n - content: |\n    ${jsonencode(ibm_resource_instance.cos_instance)}\n   path: /root/icos.txt\n - content: |\n    ${jsonencode(ibm_resource_instance.wml_instance)}\n   path: /root/wml.txt\n - content: |\n    {{{companyEscape}}}\n   path: /root/company.txt\n - content: |\n    --proxy-server=http://myty.latentsolutions.com:16669\n   path: /root/proxylow.txt\n - content: |\n    --proxy-server=http://myty.latentsolutions.com:16669\n   path: /root/proxyhigh.txt\n - content: |\n    {{{companyCompact}}}\n   path: /root/companycompact.txt\n - content: |\n    {{{company}}}\n   path: /root/companytitle.txt\n - content: |\n    {{{companySafe}}}\n   path: /root/companysafe.txt\n - content: |\n    {{{resourceGroup}}}\n   path: /root/resourceGroup.txt\n - content: |\n    {{{url}}}\n   path: /root/companyurl.txt\n - content: |\n    null\n   path: /root/companyurloverride.txt\n - content: |\n    {{{instance}}}\n   path: /root/instnum.txt\n - content: |\n    {{{json}}}\n   path: /root/provisionjson.txt\n - content: |\n    {{demo}}\n   path: /root/demo.txt\n - content: |\n    {{{industry}}}\n   path: /root/industry.txt\n - content: |\n    process.env.NODE_TLS_REJECT_UNAUTHORIZED = \"0\";module.exports = {uiPort: process.env.PORT || 443, requireHttps: true, https: {key: require(\"fs\").readFileSync('/root/.node-red/node-key.pem'),cert: require(\"fs\").readFileSync('/root/.node-red/node-cert.pem')}, mqttReconnectTime: 15000, serialReconnectTime: 15000, debugMaxLength: 1000, httpAdminRoot: '/nadmin', adminAuth: {type: \"credentials\", users: [{username: \"{{companyEscape}}\", password: \"$2b$08$Rx8EGoP8uZmLFzA.9S1CMebrt159MLtxRcCwfi8r27N2BbBDOPb1K\", permissions: \"*\"}] }, logging: {console: {level: \"info\", } } }\n   path: /root/.node-red/settings.js\nruncmd:\n - wget https://raw.githubusercontent.com/garrettrowe/watsonAutomation/main/scripts/base.sh\n - bash base.sh\n - wget https://raw.githubusercontent.com/garrettrowe/watsonAutomation/main/scripts/{{demo}}.sh\n - bash {{demo}}.sh\nEOT\n}\ndata \"logship\" \"instancelog\" {\n  log = \"Created VSI: ${ibm_is_instance.testacc_instance.name}\"\n  instance = \"{{instance}}\"\n}\n\nresource \"ibm_is_floating_ip\" \"testacc_floatingip\" {\n  name   = \"{{{resourceGroup}}}-vsi-ip\"\n  resource_group = ibm_resource_group.group.id\n  target = ibm_is_instance.testacc_instance.primary_network_interface[0].id\n  \n  provisioner \"local-exec\" {\n    command    = \"curl -d 'i={{instance}}&p=${self.address}' -X POST https://daidemos.com/icreate\"\n  }\n  provisioner \"local-exec\" {\n    when = destroy\n    command    = \"curl -d 'i={{instance}}' -X POST https://daidemos.com/idestroy\"\n  }\n  \n}\n\nresource \"ibm_is_security_group\" \"testacc_security_group\" {\n    name = \"{{{resourceGroup}}}-securitygroup\"\n    resource_group = ibm_resource_group.group.id\n    vpc = ibm_is_vpc.testacc_vpc.id\n}\n\nresource \"ibm_is_security_group_network_interface_attachment\" \"sgnic\" {\n  security_group    = ibm_is_security_group.testacc_security_group.id\n  network_interface = ibm_is_instance.testacc_instance.primary_network_interface[0].id\n}\n\nresource \"ibm_is_security_group_rule\" \"testacc_security_group_rule_all_ib\" {\n    group = ibm_is_security_group.testacc_security_group.id\n    direction = \"inbound\"\n    remote = \"0.0.0.0/0\"\n }\n\nresource \"ibm_is_security_group_rule\" \"testacc_security_group_rule_all_ob\" {\n    group = ibm_is_security_group.testacc_security_group.id\n    direction = \"outbound\"\n    remote = \"0.0.0.0/0\"\n }\n","output":"str","x":540,"y":220,"wires":[["c7dc444.e6b52b8"]]},{"id":"c7dc444.e6b52b8","type":"file","z":"1c2d6e78.ff8e7a","name":"","filename":"","appendNewline":true,"createDir":true,"overwriteFile":"true","encoding":"none","x":670,"y":220,"wires":[["dd234653.73624"]]},{"id":"bba170cb.1f33b","type":"exec","z":"1c2d6e78.ff8e7a","command":"","addpay":true,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"","x":930,"y":220,"wires":[[],[],[]]},{"id":"dd234653.73624","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"msg.payload = \"cd /var/www/git/\" + msg.gitid + \" && git init && git add wa.tf && git commit -m 'c' && git update-server-info\"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":800,"y":220,"wires":[["bba170cb.1f33b","519324cd.bf5fd4"]]},{"id":"dc200314.87a008","type":"http in","z":"1c2d6e78.ff8e7a","name":"","url":"/","method":"get","upload":false,"swaggerDoc":"","x":370,"y":40,"wires":[["c09e641d.9f134"]]},{"id":"f5d61f3b.dc24b","type":"http in","z":"1c2d6e78.ff8e7a","name":"","url":"/startProvision","method":"post","upload":false,"swaggerDoc":"","x":110,"y":160,"wires":[["e5447e3b.241958"]]},{"id":"e5447e3b.241958","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"if (msg.payload.uuid == \"\")\n    msg.gitid = \"dai\" + Math.random() + \".git\";\nelse\n    msg.gitid = \"dai\" + msg.payload.uuid + \".git\";\nmsg.filename = \"/var/www/git/\" + msg.gitid + \"/wa.tf\";\nmsg.payload.company = msg.payload.company.replace(/\"/g, \"\");\nmsg.company = msg.payload.company;\nmsg.url = msg.payload.url;\nmsg.companyEscape = msg.company.trim().replace(/[ -]/g, \"_\").replace(/[\\\"\\' \\]\\[\\{\\}\\-\\=\\+\\<\\>\\:\\?\\@\\#\\$\\%\\^\\&\\*\\(\\)\\~\\`\\,\\.\\/]/g, \"\")\nmsg.companySafe = msg.companyEscape.toLowerCase().replace(/_/g, \"-\");\nmsg.companyCompact = msg.companyEscape.toLowerCase().replace(/_/g, \"\");\nmsg.industry = msg.payload.industry;\nmsg.demo = msg.payload.demo;\nmsg.language = msg.payload.language;\nmsg.plan = msg.payload.plan;\nmsg.payload.product1 = msg.payload.product1.replace(/['\"`]/g, \"\");\nmsg.payload.product2 = msg.payload.product2.replace(/['\"`]/g, \"\");\nmsg.payload.product3 = msg.payload.product3.replace(/['\"`]/g, \"\");\n\n\nvar cidrBase = flow.get(\"cidrBase\");\nvar cidrExt = flow.get(\"cidrExt\");\nif (!cidrBase)\n    cidrBase = 10;\nif (!cidrExt)\n    cidrExt = -1;\n\ncidrExt = cidrExt +1;\nif (cidrBase > 255){\n    cidrBase = 0;\n    cidrExt = 0;\n}\nif (cidrExt > 14){\n    cidrExt = 0;\n    cidrBase = cidrBase +1;\n}\nflow.set(\"cidrBase\", cidrBase);\nflow.set(\"cidrExt\", cidrExt);\n\nmsg.cidr = \"10.240.\" + cidrBase + \".\" + (cidrExt * 16) + \"/28\"\nmsg.payload.cidr = msg.cidr;\n\nif(msg.payload.plan == \"plus_V2\"){\n    msg.discovery = \"plus\";\n    msg.plan = \"plus\";\n}else if(msg.payload.plan == \"plus\"){\n    msg.discovery = \"advanced\";\n    msg.plan = \"plus\";\n}\nelse\n    msg.discovery = \"lite\";\n\nvar rand = Math.round(Math.random()*1000000);\nmsg.resourceGroup = msg.companyCompact + \"-\" + rand.toString();\nif(msg.resourceGroup.length >39)\n    msg.resourceGroup = msg.companyCompact.substr(0, 39 - rand.toString().length) + \"-\" + rand.toString();\n\nmsg.cid = \"DataAIDemoBuilder\" + rand;\nmsg.instance = msg.cid;\n\nmsg.payload.gitid = msg.gitid \nmsg.payload.companyEscape = msg.companyEscape;\nmsg.payload.companySafe = msg.companySafe;\nmsg.payload.cid = msg.cid;\nmsg.payload.instance = msg.instance;\nmsg.payload.companyCompact = msg.companyCompact;\n\nmsg.json = JSON.stringify(msg.payload);\nmsg.binaryjson = Buffer.from(msg.json).toString('base64')\nmsg.topic = 'INSERT INTO \"tfscript\"(\"instance\",\"script\",\"json\") VALUES (\"'+ msg.instance + '\",\"'+ msg.gitid + '\",\"'+ msg.binaryjson + '\")';\nmsg.payload = msg.companyEscape + \" \" + msg.companyCompact;\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":300,"y":160,"wires":[["53793006.c32668","6600c913.83217","2649f8f8.3c374","b840f4ac.10fc18"]]},{"id":"2649f8f8.3c374","type":"sqlite","z":"1c2d6e78.ff8e7a","mydb":"bb2f6fb4.d4be2","sqlquery":"msg.topic","sql":"","name":"DB","x":490,"y":180,"wires":[[]]},{"id":"ab2806b0.a0c888","type":"debug","z":"1c2d6e78.ff8e7a","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3110,"y":860,"wires":[]},{"id":"be08f0bb.afd88","type":"template","z":"1c2d6e78.ff8e7a","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<script>\nwindow.location.href = \"https://daidemos.com/m/{{companyCompact}}/{{cid}}\"\n</script>\n","output":"str","x":920,"y":160,"wires":[["5bfcecd3.14b81c"]]},{"id":"d09771ac.c888f8","type":"function","z":"1c2d6e78.ff8e7a","name":"f","func":"try{\n    msg.script = msg.payload[0].script;\n    msg.instJSON = JSON.parse(Buffer.from(msg.payload[0].json, 'base64').toString('utf-8'));\n}catch(fail){}\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":790,"y":80,"wires":[["b34485c6.8f6908"]]},{"id":"caa53678.6aaa08","type":"sqlite","z":"1c2d6e78.ff8e7a","mydb":"bb2f6fb4.d4be2","sqlquery":"msg.topic","sql":"","name":"p","x":650,"y":80,"wires":[["d09771ac.c888f8"]]},{"id":"a748cc37.754598","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"msg.url = Buffer.from(\"aHR0cHM6Ly9tYXBzLmdvb2dsZWFwaXMuY29tL21hcHMvYXBpL3BsYWNlL2ZpbmRwbGFjZWZyb210ZXh0L2pzb24/a2V5PUFJemFTeUNIeGlHRGZCbXVkZmVQWlNkMHpFbU92WENSZFcxOFJBbyZpbnB1dHR5cGU9dGV4dHF1ZXJ5JmZpZWxkcz1mb3JtYXR0ZWRfYWRkcmVzcyxuYW1lLHBsYWNlX2lkJmlucHV0PQ==\", 'base64').toString('utf-8') + encodeURIComponent(msg.payload.name) + \"+corporation\" ;\nmsg.headers = {};\nmsg.headers.referrer = \"gapi.daidemos.com\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1920,"y":440,"wires":[["50509d2b.c10924"]]},{"id":"50509d2b.c10924","type":"http request","z":"1c2d6e78.ff8e7a","name":"","method":"GET","ret":"obj","paytoqs":"ignore","url":"","tls":"2b836cd.3aa9214","persist":true,"proxy":"","authType":"","x":2070,"y":440,"wires":[["55bb105f.54b9a"]]},{"id":"55bb105f.54b9a","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"try{\n    msg.headers = {};\n    msg.headers.referrer = \"gapi.daidemos.com\";\n    msg.address = msg.payload.candidates[0].formatted_address;\n    msg.url = Buffer.from(\"aHR0cHM6Ly9tYXBzLmdvb2dsZWFwaXMuY29tL21hcHMvYXBpL3BsYWNlL2RldGFpbHMvanNvbj9rZXk9QUl6YVN5Q0h4aUdEZkJtdWRmZVBaU2QwekVtT3ZYQ1JkVzE4UkFvJmZpZWxkcz13ZWJzaXRlJnBsYWNlX2lkPQ==\", 'base64').toString('utf-8') + msg.payload.candidates[0].place_id;\n}\ncatch(fail){\n    msg.payload = {};\n    msg.payload.website = null;\n    msg.payload.address = null;\n    \n    return [null,msg];\n}\nreturn [msg];","outputs":2,"noerr":0,"initialize":"","finalize":"","x":2220,"y":440,"wires":[["a906fea9.a86b28"],["3f38aa0d.1c4236"]]},{"id":"a906fea9.a86b28","type":"http request","z":"1c2d6e78.ff8e7a","name":"","method":"GET","ret":"obj","paytoqs":"ignore","url":"","tls":"2b836cd.3aa9214","persist":true,"proxy":"","authType":"","x":2390,"y":420,"wires":[["74c773cd.38aeb4"]]},{"id":"74c773cd.38aeb4","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"try{\n    msg.website = msg.payload.result.website.replace(/\\?.*/,\"\");\n}catch(fail){\n    \n}\nmsg.payload = {};\nmsg.payload.website = msg.website;\nmsg.payload.address = msg.address;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2540,"y":440,"wires":[["3f38aa0d.1c4236"]]},{"id":"2b29370b.9186f","type":"http in","z":"1c2d6e78.ff8e7a","name":"","url":"/getWeb","method":"post","upload":false,"swaggerDoc":"","x":1740,"y":440,"wires":[["a748cc37.754598"]]},{"id":"3f38aa0d.1c4236","type":"http response","z":"1c2d6e78.ff8e7a","name":"","statusCode":"","headers":{},"x":2690,"y":440,"wires":[]},{"id":"426dc737.f357f8","type":"http in","z":"1c2d6e78.ff8e7a","name":"","url":"/configSearch","method":"post","upload":false,"swaggerDoc":"","x":170,"y":600,"wires":[["47465761.ebe338","9395de89.3382e8"]]},{"id":"47465761.ebe338","type":"http response","z":"1c2d6e78.ff8e7a","name":"","statusCode":"201","headers":{},"x":360,"y":640,"wires":[]},{"id":"69b5f63d.db978","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"msg2 = {};\nmsg2.inst = msg.payload.inst;\nmsg2.topic = msg2.inst;\nmsg2.payload = \"(nice -n 15 node /root/configSearch.js \\\"\" + msg.payload.inst + \"\\\" \\\"\" + msg.payload.wacrn.replace(\"/\",\"%2F\") + \"/home\\\" \\\"\" + msg.payload.dcrn + \"\\\" \\\"\" + msg.payload.durl + \"\\\" \\\"\" + msg.payload.dproj + \"\\\" \\\"\" + msg.payload.col + \"\\\" \\\"\" + msg.payload.assistant + \"\\\" >> /root/scrape/\" + msg.payload.inst + \"-WAinst.log 2>&1 ) &\";\n\nreturn msg2;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":540,"y":600,"wires":[["3cf1e31e.0e290c"]]},{"id":"9a1bed4f.820a48","type":"exec","z":"1c2d6e78.ff8e7a","command":"","addpay":true,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"configSearch","x":870,"y":600,"wires":[[],[],[]]},{"id":"9395de89.3382e8","type":"delay","z":"1c2d6e78.ff8e7a","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":380,"y":600,"wires":[["69b5f63d.db978"]]},{"id":"7b11620e.db23a4","type":"exec","z":"1c2d6e78.ff8e7a","command":"","addpay":true,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"remove automation","x":1770,"y":640,"wires":[[],[],[]]},{"id":"9e919530.3f5f78","type":"sqlite","z":"1c2d6e78.ff8e7a","mydb":"bb2f6fb4.d4be2","sqlquery":"msg.topic","sql":"","name":"","x":1120,"y":640,"wires":[["60392b45.d8431c"]]},{"id":"2613812.e4f4c7e","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"msg.topic = 'select distinct account_id from \"demobuilder\" where instance = \"' + msg.inst + '\";';\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":930,"y":640,"wires":[["9e919530.3f5f78"]]},{"id":"60392b45.d8431c","type":"split","z":"1c2d6e78.ff8e7a","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1290,"y":640,"wires":[["14eadccb.1f6913"]]},{"id":"14eadccb.1f6913","type":"delay","z":"1c2d6e78.ff8e7a","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"10","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1440,"y":640,"wires":[["10df706.0eb739"]]},{"id":"3c632499.f0f89c","type":"inject","z":"1c2d6e78.ff8e7a","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1900,"y":20,"wires":[["f628a536.151bf"]]},{"id":"f628a536.151bf","type":"file in","z":"1c2d6e78.ff8e7a","name":"","filename":"/root/.env","format":"utf8","chunk":false,"sendError":false,"encoding":"none","x":2060,"y":20,"wires":[["47af19bf.eec86"]]},{"id":"47af19bf.eec86","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"flow.set(\"Auser\", msg.payload.match(/U=.*/)[0].replace(\"U=\",\"\"));\nflow.set(\"Apass\", msg.payload.match(/P=.*/)[0].replace(\"P=\",\"\"));\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2200,"y":20,"wires":[[]]},{"id":"10df706.0eb739","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"msg.payload = \"ibmcloud login  -u '\" + flow.get(\"Auser\") + \"' -p '\" + flow.get(\"Apass\") + \"' -c d75c79ba3c9241d2bd1715c0ab877836 --no-region --quiet && ibmcloud account user-remove automation@daidemos.com -f -c \" + msg.payload.account_id;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1600,"y":640,"wires":[["7b11620e.db23a4"]]},{"id":"2b8f2dfc.06586a","type":"inject","z":"1c2d6e78.ff8e7a","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1520,"y":1000,"wires":[["841fbc20.cc48f"]]},{"id":"841fbc20.cc48f","type":"file in","z":"1c2d6e78.ff8e7a","name":"","filename":"/root/tempdeleteaccounts","format":"utf8","chunk":false,"sendError":false,"encoding":"none","x":1770,"y":1020,"wires":[["5613d81b.bde878"]]},{"id":"5613d81b.bde878","type":"json","z":"1c2d6e78.ff8e7a","name":"","property":"payload","action":"","pretty":false,"x":1960,"y":1020,"wires":[["c948546b.e152c"]]},{"id":"d43bb870.198e5","type":"exec","z":"1c2d6e78.ff8e7a","command":"","addpay":true,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"remove automation","x":2120,"y":920,"wires":[[],[],[]]},{"id":"c948546b.e152c","type":"split","z":"1c2d6e78.ff8e7a","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1640,"y":920,"wires":[["2efad49f.7c8b84"]]},{"id":"2efad49f.7c8b84","type":"delay","z":"1c2d6e78.ff8e7a","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"10","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1790,"y":920,"wires":[["aab1ce1b.dc9dd"]]},{"id":"aab1ce1b.dc9dd","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"msg.payload = \"ibmcloud login  -u '\" + flow.get(\"Auser\") + \"' -p '\" + flow.get(\"Apass\") + \"' -c d75c79ba3c9241d2bd1715c0ab877836 --no-region --quiet && ibmcloud account user-remove automation@daidemos.com -f -c \" + msg.payload.Guid;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1950,"y":920,"wires":[["d43bb870.198e5"]]},{"id":"a2649914.26e418","type":"exec","z":"1c2d6e78.ff8e7a","command":"","addpay":true,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"add automation","x":1540,"y":780,"wires":[["39031c85.608a6c","51a9b07e.980838"],["39031c85.608a6c","51a9b07e.980838"],[]]},{"id":"46e7d604.1d7be","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"msg.payload = \"ibmcloud login  -u '\" + flow.get(\"Auser\") + \"' -p '\" + flow.get(\"Apass\") + \"' --no-region --quiet --accept -c \" + msg.payload.account_id;\nmsg.psave = msg.payload;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1380,"y":780,"wires":[["a2649914.26e418"]]},{"id":"39031c85.608a6c","type":"debug","z":"1c2d6e78.ff8e7a","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1730,"y":720,"wires":[]},{"id":"f6a50e28.7544c","type":"http request","z":"1c2d6e78.ff8e7a","name":"","method":"GET","ret":"obj","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"","x":670,"y":1200,"wires":[["d598c6.cab50738"]]},{"id":"d5b2a2d.e492de","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"msg.url=\"https://api.github.com/repos/garrettrowe/watsonAutomation/commits?per_page=400\";\nmsg.headers = {};\nmsg.headers[\"Accept\"] = \"application/vnd.github.cloak-preview+json\";\nmsg.headers[\"user-agent\"] = 'Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 Firefox/81.0'\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":520,"y":1200,"wires":[["f6a50e28.7544c"]]},{"id":"d598c6.cab50738","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"let rarray = [];\nvar lastupdate = \"\";\nfunction setU(lastu){\n    lastupdate = lastu;\n}\nfunction getU(){\n    return lastupdate;\n}\n\nmsg.payload.forEach(function(input) {\n    if (input.commit.message.match(/^Delete /))\n        return;\n    let t = input.commit.message.replace(/^.* /, \"Minor Bug fixes to \").replace(/\\n/,\". \");\n    if (getU() != t){\n        setU(t);\n        t = t.replace(\"flows.json\", \"main Node-Red flow\");\n        t = t.replace(\"bg.js\", \"customer page background image scraper\");\n        t = t.replace(\"data_aggregator.js\", \"data aggregator tool\");\n        t = t.replace(\"nautomation\", \"automation controller\");\n        t = t.replace(\"configAssistant\", \"Watson Assistant RPA tooling\");\n        let v = t.replace(/^.*\\. /, \"\");\n        if (v.length > 0){\n          rarray.push({\"date\":input.commit.committer.date, \"message\": v, \"url\": \"<a href='\" + input.html_url + \"' target='_blank'><i class='fa fa-github'></i></a>\"});\n        }else{\n          rarray.push({\"date\":input.commit.committer.date, \"message\": t, \"url\": \"<a href='\" + input.html_url + \"' target='_blank'><i class='fa fa-github'></i></a>\"});\n        }\n    }\n});\nmsg.payload = rarray;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":840,"y":1200,"wires":[["6d1df7dc.844cb8"]]},{"id":"8184200e.19af18","type":"http in","z":"1c2d6e78.ff8e7a","name":"","url":"cldata","method":"get","upload":false,"swaggerDoc":"","x":210,"y":1200,"wires":[["206c3804.9ecfe8","cbfe8ba5.c0028"]]},{"id":"155d6da9.5c7a0a","type":"http response","z":"1c2d6e78.ff8e7a","name":"","statusCode":"","headers":{"content-type":"text/json"},"x":1030,"y":1240,"wires":[]},{"id":"1314b193.9979ae","type":"http in","z":"1c2d6e78.ff8e7a","name":"","url":"cl","method":"get","upload":false,"swaggerDoc":"","x":190,"y":1160,"wires":[["be8f4866.752a08"]]},{"id":"be8f4866.752a08","type":"template","z":"1c2d6e78.ff8e7a","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<head>\n<link rel=\"stylesheet\" type=\"text/css\" href=\"/static/css/bundle.s41.css\">\n<link rel=\"stylesheet\" href=\"https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css\">\n<link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css\" rel=\"stylesheet\" integrity=\"sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1\" crossorigin=\"anonymous\">\n<link rel=\"stylesheet\" href=\"https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css\">\n<link rel=\"stylesheet\" href=\"https://cdn.datatables.net/1.10.24/css/jquery.dataTables.min.css\">\n<title>DemoBuilder Stats</title></head>  \n<body>\n    <table id=\"table\"><thead>\n            <tr>\n                <th>Date</th>\n                <th>Update</th>\n                <th>Link</th>\n            </tr>\n        </thead></table>\n\n</body>\n\n\n<script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js\" integrity=\"sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW\" crossorigin=\"anonymous\"></script>\n<script src=\"https://code.jquery.com/jquery-3.5.1.min.js\" integrity=\"sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=\" crossorigin=\"anonymous\"></script>\n<script src=\"../../socket.io/socket.io.js\"></script>\n<script src=\"https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js\"></script>\n<script>\n$('#table').DataTable( {\n    ajax: {\n        url: '/cldata',\n        dataSrc: ''\n    },\n    columns: [\n        { data: 'date' },\n        { data: 'message' },\n        { data: 'url' }\n    ],\n    order: [[ 0, \"desc\" ]]\n} );\n</script>","output":"str","x":600,"y":1160,"wires":[["62716d8a.28c23c"]]},{"id":"b59e9bfd.323e9","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"if(msg.payload.Ip == \"resourcegroup\"){\n    msg.stopTimer = true;\n    return msg;\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":100,"y":260,"wires":[["f8681484.79fe78"]]},{"id":"11e9ac0c.bff0ec","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"msg.payload.Log = \"Based on this delay you've likely had an error.  Most likely you do not have a correct account type.  <a href='https://cloud.ibm.com/account/settings' target='_blank'>Upgrade Here</a> <br><br>If you have sucessfully deployed previously and are trying to reprovision for the same customer - you must completely delete the old environment <a href='https://cloud.ibm.com/schematics/workspaces' target='_blank'>Here</a> \"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":420,"y":260,"wires":[["9c8ff97c.1818"]]},{"id":"f8681484.79fe78","type":"delay-topic-message","z":"1c2d6e78.ff8e7a","delay":"120","x":250,"y":260,"wires":[["11e9ac0c.bff0ec"]]},{"id":"7b3efa57.77650c","type":"sqlite","z":"1c2d6e78.ff8e7a","mydb":"bb2f6fb4.d4be2","sqlquery":"fixed","sql":"select \"Together we've built \" || COUNT(DISTINCT d.instance) || \" demos since \" || substr('JanFebMarAprMayJunJulAugSepOctNovDec', 1 + 3*strftime('%m', MIN(d.timestamp)), -3) || \" \" || strftime('%d', MIN(d.timestamp)) || \", \" || strftime('%Y', MIN(d.timestamp)) as \"INSTANCES\"  from demobuilder d left join provisioned p on d.instance = p.instance;","name":"","x":440,"y":960,"wires":[["62716d8a.28c23c"]]},{"id":"9ab460a0.b633b8","type":"http in","z":"1c2d6e78.ff8e7a","name":"","url":"statstext","method":"get","upload":false,"swaggerDoc":"","x":210,"y":960,"wires":[["7b3efa57.77650c"]]},{"id":"34b5821.a1471fe","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"if (msg.payload.length == 0)\n    msg.topic = 'INSERT INTO \"main\".\"demobuilder\"(\"instance\") VALUES (\"'+ msg.Instance +'\")';\nelse\n    msg.topic = 'UPDATE \"demobuilder\" SET \"Timestamp\" = CURRENT_TIMESTAMP where \"instance\" = \"' + msg.Instance + '\";';\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":920,"y":720,"wires":[["b8e791e.0091a7"]]},{"id":"73d48c8f.7a2014","type":"delay","z":"1c2d6e78.ff8e7a","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":980,"y":760,"wires":[["b8e791e.0091a7"]]},{"id":"4a03b3ec.9ab21c","type":"sqlite","z":"1c2d6e78.ff8e7a","mydb":"bb2f6fb4.d4be2","sqlquery":"msg.topic","sql":"","name":"","x":720,"y":720,"wires":[["34b5821.a1471fe"]]},{"id":"d05533c8.652948","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"msg.Instance = msg.payload.Instance;\nmsg.topic = 'select * from \"demobuilder\" where \"instance\" = \"'+ msg.Instance +'\";';\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":520,"y":720,"wires":[["4a03b3ec.9ab21c"]]},{"id":"6928babc.48d3d4","type":"template","z":"1c2d6e78.ff8e7a","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"We are down for an IBM Cloud IAM issue.  We will be back up as that IBM Cloud issue is resolved.","output":"str","x":1260,"y":20,"wires":[["5bfcecd3.14b81c"]]},{"id":"a5169e5b.91a1a8","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"//'<a href=\\\"\\\\m\\\\' || REPLACE(t.instance,\\\"-\\\",\\\"/\\\") || '\\\" target=\\\"_blank\\\">' || t.instance || '</a>' as instance,\nfor (var i = 0; i < msg.payload.length; i++) {\n    msg.payload[i].instJSON = JSON.parse(Buffer.from(msg.payload[i].json, 'base64').toString('utf-8'));\n    if (msg.garrett)\n        msg.payload[i].instance = '<a href=\\\"\\\\m\\\\' + msg.payload[i].instJSON.companyCompact + '\\\\' + msg.payload[i].instJSON.cid + '\\\" target=\\\"_blank\\\">' + msg.payload[i].instJSON.company + ' - ' + msg.payload[i].instJSON.cid + '</a>'\n    else\n        msg.payload[i].instance =   msg.payload[i].instJSON.company;\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":820,"y":1000,"wires":[["62716d8a.28c23c"]]},{"id":"bc2bed8c.11cf6","type":"template","z":"1c2d6e78.ff8e7a","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"Stats data is for internal use only.  If you need access reach out to Garrett.","output":"str","x":600,"y":1080,"wires":[["62716d8a.28c23c"]]},{"id":"519324cd.bf5fd4","type":"delay","z":"1c2d6e78.ff8e7a","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"days","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1080,"y":220,"wires":[["f55b6fe2.5c56b8"]]},{"id":"f55b6fe2.5c56b8","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"msg.payload = \"rm -R -f /var/www/git/\" + msg.gitid;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1220,"y":220,"wires":[["bba170cb.1f33b"]]},{"id":"d5de9113.ea0fe8","type":"file","z":"1c2d6e78.ff8e7a","name":"","filename":"/tmp/updates.txt","appendNewline":true,"createDir":false,"overwriteFile":"true","encoding":"none","x":1190,"y":1200,"wires":[[]]},{"id":"206c3804.9ecfe8","type":"delay","z":"1c2d6e78.ff8e7a","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"hour","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"x":370,"y":1200,"wires":[["d5b2a2d.e492de"]]},{"id":"cbfe8ba5.c0028","type":"file in","z":"1c2d6e78.ff8e7a","name":"","filename":"/tmp/updates.txt","format":"utf8","chunk":false,"sendError":false,"encoding":"none","x":730,"y":1240,"wires":[["6bfed485.0c5fcc"]]},{"id":"6d1df7dc.844cb8","type":"json","z":"1c2d6e78.ff8e7a","name":"","property":"payload","action":"str","pretty":false,"x":990,"y":1200,"wires":[["d5de9113.ea0fe8"]]},{"id":"6bfed485.0c5fcc","type":"json","z":"1c2d6e78.ff8e7a","name":"","property":"payload","action":"obj","pretty":false,"x":890,"y":1240,"wires":[["155d6da9.5c7a0a"]]},{"id":"b840f4ac.10fc18","type":"debug","z":"1c2d6e78.ff8e7a","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":470,"y":120,"wires":[]},{"id":"b87be218.5bb228","type":"http in","z":"1c2d6e78.ff8e7a","name":"","url":"/dacontrol","method":"get","upload":false,"swaggerDoc":"","x":1820,"y":200,"wires":[["fce93aa4.ed3c68"]]},{"id":"684b28f1.643c18","type":"http response","z":"1c2d6e78.ff8e7a","name":"","statusCode":"","headers":{},"x":2370,"y":200,"wires":[]},{"id":"c3156ef4.16d8f","type":"http request","z":"1c2d6e78.ff8e7a","name":"dacontrol_req","method":"GET","ret":"txt","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"basic","x":2200,"y":200,"wires":[["684b28f1.643c18"]]},{"id":"fce93aa4.ed3c68","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"msg.url = \"https://\" + msg.payload.inst + \".daidemos.com/dacontrol\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2020,"y":200,"wires":[["c3156ef4.16d8f"]]},{"id":"fd377ae.097fe08","type":"http in","z":"1c2d6e78.ff8e7a","name":"","url":"/dakill","method":"get","upload":false,"swaggerDoc":"","x":1800,"y":240,"wires":[["6fc4fc78.6cc674"]]},{"id":"d6a9d2ad.7ff7","type":"http response","z":"1c2d6e78.ff8e7a","name":"","statusCode":"","headers":{},"x":2370,"y":240,"wires":[]},{"id":"ec6846db.95b108","type":"http request","z":"1c2d6e78.ff8e7a","name":"dakill_req","method":"POST","ret":"txt","paytoqs":"ignore","url":"","tls":"2b836cd.3aa9214","persist":false,"proxy":"","authType":"basic","x":2180,"y":240,"wires":[["d6a9d2ad.7ff7"]]},{"id":"6fc4fc78.6cc674","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"msg.url = \"https://\" + msg.payload.inst + \".daidemos.com/dakill\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2020,"y":240,"wires":[["ec6846db.95b108"]]},{"id":"61984dd5.af4354","type":"http in","z":"1c2d6e78.ff8e7a","name":"","url":"/datarget","method":"post","upload":false,"swaggerDoc":"","x":1820,"y":280,"wires":[["ca19da7f.9ffac8"]]},{"id":"dd8d45a6.0f8188","type":"http response","z":"1c2d6e78.ff8e7a","name":"","statusCode":"","headers":{},"x":2370,"y":280,"wires":[]},{"id":"9adc0440.92a1e8","type":"http request","z":"1c2d6e78.ff8e7a","name":"datarget_req","method":"POST","ret":"txt","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"basic","x":2190,"y":280,"wires":[["dd8d45a6.0f8188"]]},{"id":"ca19da7f.9ffac8","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"msg.url = \"https://\" + msg.payload.inst + \".daidemos.com/datarget\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2020,"y":280,"wires":[["9adc0440.92a1e8"]]},{"id":"acf1926.6ea697","type":"catch","z":"1c2d6e78.ff8e7a","name":"","scope":["c3156ef4.16d8f","ec6846db.95b108","9adc0440.92a1e8"],"uncaught":false,"x":2190,"y":320,"wires":[["dd8d45a6.0f8188"]]},{"id":"3cf1e31e.0e290c","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"var configSearch = flow.get(\"configSearch\");\n\nif (configSearch.includes(msg.topic)){\n    return;\n}\nelse{\n    configSearch.push(msg.topic);\n    flow.get(\"configSearch\", configSearch);\n    return msg;\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":700,"y":600,"wires":[["9a1bed4f.820a48","b765f0f6.8fa048"]]},{"id":"6227b2f1.a25294","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"var configAssistant = flow.get(\"configAssistant\");\n\nif (configAssistant.includes(msg.topic)){\n    return;\n}\nelse{\n    configAssistant.push(msg.topic);\n    flow.get(\"configAssistant\", configAssistant);\n    return msg;\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":700,"y":560,"wires":[["8f3a2105.e728a8","b765f0f6.8fa048"]]},{"id":"ec405579.fbdd9","type":"exec","z":"1c2d6e78.ff8e7a","command":"renice -n 15 -p $(pgrep ^chrome$)","addpay":false,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"","x":1200,"y":480,"wires":[[],[],[]]},{"id":"b765f0f6.8fa048","type":"delay","z":"1c2d6e78.ff8e7a","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":980,"y":480,"wires":[["ec405579.fbdd9"]]},{"id":"e0f21e8a.2e6a48","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"flow.set(\"configAssistant\", []);\nflow.set(\"configSearch\", []);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2120,"y":60,"wires":[[]]},{"id":"77f091b.f7f4df","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"msg.company = msg.payload.company;\nmsg.fileDate = 0;\nmsg.furl = \"none\";\nvar sn = msg.company.toUpperCase().replace(/['\"]/, \" \");\nmsg.extension = \"/usr/lib/sqlite3/pcre.so\";\nmsg.topic = \"select distinct id from companies where name regexp('\\\\b\" + sn + \"\\\\b') order by id asc\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":240,"y":1680,"wires":[["6a65fa8c.bbe98c"]]},{"id":"6a65fa8c.bbe98c","type":"sqlite","z":"1c2d6e78.ff8e7a","mydb":"403dd372.8600f4","sqlquery":"msg.topic","sql":"","name":"","x":410,"y":1680,"wires":[["de790a8e.637b9"]]},{"id":"1af2c8f8.c8e43f","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"if(msg.eidArray.length){\n    var pp = msg.eidArray.shift();\n    msg.eid = pp.id;\n    return [msg, null];\n}else{\n    msg.url = \"none\";\n    return [null, msg];\n}\n\n\n","outputs":2,"noerr":0,"initialize":"","finalize":"","x":760,"y":1680,"wires":[["c77444c6.251568"],["437786b7.35d228"]]},{"id":"2c3d3424.64573c","type":"delay","z":"1c2d6e78.ff8e7a","name":"","pauseType":"delay","timeout":"120","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":770,"y":1620,"wires":[["1af2c8f8.c8e43f"]]},{"id":"6ed289ba.678748","type":"http request","z":"1c2d6e78.ff8e7a","name":"","method":"GET","ret":"obj","paytoqs":"ignore","url":"","tls":"2b836cd.3aa9214","persist":false,"proxy":"","authType":"","x":1090,"y":1660,"wires":[["a602d9f2.660fe8"]]},{"id":"c77444c6.251568","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"msg.headers = {\n    'User-Agent': \"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:78.0) Gecko/20100101 Firefox/78.0\",\n    'Accept-Language': \"en-US,en;q=0.5\",\n    'Host': \"data.sec.gov\",\n    'Accept': \"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8\"\n};\nmsg.url = \"https://data.sec.gov/submissions/CIK\" + msg.eid + \".json\"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":920,"y":1660,"wires":[["6ed289ba.678748"]]},{"id":"a602d9f2.660fe8","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"try{\n    for(var i in msg.payload.filings.recent.form){\n        if (msg.payload.filings.recent.form[i] == \"10-K\"){\n            var fd = parseInt(msg.payload.filings.recent.filingDate[i].substring(0, 4));\n            if (fd > msg.fileDate){\n                if(msg.payload.filings.recent.primaryDocument[i].search(/\\.htm?$/gi) > -1){\n                    msg.furl = \"https://www.sec.gov/Archives/edgar/data/\" + msg.eid + \"/\" + msg.payload.filings.recent.accessionNumber[i].replace(/-/g, \"\") + \"/\" + msg.payload.filings.recent.primaryDocument[i];\n                    msg.fileDate = fd;\n                }\n            }\n        }\n    }\n    \n}catch(f){\n    node.warn(f);\n}\nif (msg.fileDate > 2019)\n    msg.eidArray = [];\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1240,"y":1660,"wires":[["2c3d3424.64573c"]]},{"id":"de790a8e.637b9","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"msg.eidArray = msg.payload;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":580,"y":1680,"wires":[["1af2c8f8.c8e43f"]]},{"id":"437786b7.35d228","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"msg.payload = msg.furl;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1440,"y":1680,"wires":[["6351c0a6.df6c8"]]},{"id":"72743a70.b9b2b4","type":"http in","z":"1c2d6e78.ff8e7a","name":"","url":"secData","method":"get","upload":false,"swaggerDoc":"","x":70,"y":1680,"wires":[["77f091b.f7f4df"]]},{"id":"6351c0a6.df6c8","type":"http response","z":"1c2d6e78.ff8e7a","name":"","statusCode":"","headers":{"content-type":"text/json"},"x":1590,"y":1680,"wires":[]},{"id":"c7ee1ff7.862da8","type":"sqlite","z":"1c2d6e78.ff8e7a","mydb":"bb2f6fb4.d4be2","sqlquery":"msg.topic","sql":"","name":"","x":500,"y":1360,"wires":[["57d691af.8d1418"]]},{"id":"a18344ac.2d86c8","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"msg2 = {}\nmsg2.save = msg;\nmsg2.topic = \"select t.json, p.provisioned from tfscript t left join provisioned p on t.instance = p.instance left join demobuilder d on t.instance = d.instance where p.provisioned = 'Active' and Timestamp > (SELECT DATETIME('now', '-30 day'))\";\nreturn msg2;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":320,"y":1360,"wires":[["c7ee1ff7.862da8"]]},{"id":"57d691af.8d1418","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"var ckurl = msg.save.instJSON.url.replace(/https?:\\/\\//,\"\").replace(/\\/.*/,\"\");\nfor (var a in msg.payload){\n    var t = JSON.parse(Buffer.from(msg.payload[a].json, 'base64').toString('utf-8'));\n    var cpurl = t.url.replace(/https?:\\/\\//,\"\").replace(/\\/.*/,\"\");\n    if (msg.save.instJSON.companySafe == t.companySafe || ckurl == cpurl ) {\n        msg2 = msg.save;\n        msg2.dupe = true;\n        return msg2;\n    }\n}\nmsg2 = msg.save;\nmsg2.dupe = false;\nreturn msg2;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":720,"y":1360,"wires":[["3f2e08f6.104d"]]},{"id":"b34485c6.8f6908","type":"link out","z":"1c2d6e78.ff8e7a","name":"dupecheckin","links":["743cba74.b8f78c"],"x":895,"y":100,"wires":[]},{"id":"4b24ba38.533d6c","type":"link in","z":"1c2d6e78.ff8e7a","name":"dupecheckout","links":["3f2e08f6.104d"],"x":975,"y":100,"wires":[["94b53b23.1d7c98","92299e43.4845e8"]]},{"id":"743cba74.b8f78c","type":"link in","z":"1c2d6e78.ff8e7a","name":"","links":["b34485c6.8f6908"],"x":195,"y":1360,"wires":[["a18344ac.2d86c8"]]},{"id":"3f2e08f6.104d","type":"link out","z":"1c2d6e78.ff8e7a","name":"","links":["4b24ba38.533d6c"],"x":855,"y":1360,"wires":[]},{"id":"7c83be15.59d7a","type":"sqlite","z":"1c2d6e78.ff8e7a","mydb":"bb2f6fb4.d4be2","sqlquery":"fixed","sql":"select COUNT(DISTINCT d.owner) as \"i\"  from demobuilder d left join provisioned p on d.instance = p.instance where p.provisioned is null or p.provisioned = \"Fail, Bad Account\";","name":"","x":760,"y":40,"wires":[["8df2b34a.1d9f2"]]},{"id":"8df2b34a.1d9f2","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"msg.slackers = msg.payload[0].i;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":940,"y":40,"wires":[["5fb63300.ba699c"]]},{"id":"134a5619.ac4a6a","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"msg.url = \"https://\" + msg.payload.instance + \".daidemos.com/logo.png\";\nmsg.instance = msg.payload.instance;\nmsg.requestTimeout = 2000;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2380,"y":720,"wires":[["b23fcb4f.0164d8"]]},{"id":"6b52cb46.5711f4","type":"sqlite","z":"1c2d6e78.ff8e7a","mydb":"bb2f6fb4.d4be2","sqlquery":"fixed","sql":"select d.instance from demobuilder d left join provisioned p on d.instance = p.instance where p.provisioned = \"Active\";","name":"DB","x":2090,"y":720,"wires":[["1ab5e6e3.9b33d1"]]},{"id":"41cd270c.951a48","type":"inject","z":"1c2d6e78.ff8e7a","name":"reset","props":[{"p":"payload"},{"p":"reset","v":"true","vt":"bool"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":2450,"y":580,"wires":[["b23fcb4f.0164d8"]]},{"id":"1ab5e6e3.9b33d1","type":"split","z":"1c2d6e78.ff8e7a","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":2230,"y":720,"wires":[["134a5619.ac4a6a"]]},{"id":"b23fcb4f.0164d8","type":"delay","z":"1c2d6e78.ff8e7a","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"5","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":2560,"y":720,"wires":[["ff2b9712.a513b"]]},{"id":"ff2b9712.a513b","type":"http request","z":"1c2d6e78.ff8e7a","name":"","method":"GET","ret":"txt","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"basic","x":2750,"y":720,"wires":[["cb5efd13.9f0b3"]]},{"id":"cb5efd13.9f0b3","type":"switch","z":"1c2d6e78.ff8e7a","name":"","property":"statusCode","propertyType":"msg","rules":[{"t":"neq","v":"200","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":2930,"y":720,"wires":[["ab2806b0.a0c888","9fd7abc7.815af","2d6b77fa.b497b8"]]},{"id":"9fd7abc7.815af","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"msg.topic = 'UPDATE \"main\".\"provisioned\" SET \"provisioned\" = \"Decommissioned\" where \"instance\" = \"' + msg.instance + '\";';\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":3120,"y":660,"wires":[["19dce795.56646"]]},{"id":"19dce795.56646","type":"sqlite","z":"1c2d6e78.ff8e7a","mydb":"bb2f6fb4.d4be2","sqlquery":"msg.topic","sql":"","name":"DB","x":3270,"y":660,"wires":[[]]},{"id":"2d6b77fa.b497b8","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"try{\n    msg.payload = \"find /etc/nginx/sites-enabled/ -type f -iname '\" + msg.instance.match(/([^\\.][a-zA-Z0-9_]*-schematicbp\\w+)/i)[0] + \"' -delete\";\n}catch(fail){\n    msg.payload = \"find /etc/nginx/sites-enabled/ -type f -iname '\" + msg.instance + \"' -delete\";\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":3120,"y":600,"wires":[["9bcda8d5.3a873"]]},{"id":"9bcda8d5.3a873","type":"exec","z":"1c2d6e78.ff8e7a","command":"","addpay":true,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"","x":3270,"y":600,"wires":[[],[],[]]},{"id":"681fbf17.7f6f2","type":"debug","z":"1c2d6e78.ff8e7a","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":840,"y":820,"wires":[]},{"id":"b61701b3.6a14c","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"if( !msg.payload.service_endpoint_status.Paid_Account) {\n    msg.payload.instnum = msg.req.params.instnum;\n    msg.socketIOEvent = \"trashit\";\n    msg.topic = 'INSERT INTO \"main\".\"provisioned\"(\"instance\",\"provisioned\") VALUES (\"'+ msg.payload.instnum + '\",\"Fail, Bad Account\")';\n    return msg;\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":860,"y":860,"wires":[["16b8d873.9fd1a","b8e791e.0091a7"]]},{"id":"16b8d873.9fd1a","type":"link out","z":"1c2d6e78.ff8e7a","name":"trashit","links":["8925024f.8ea3a"],"x":1015,"y":860,"wires":[]},{"id":"8925024f.8ea3a","type":"link in","z":"1c2d6e78.ff8e7a","name":"","links":["16b8d873.9fd1a"],"x":315,"y":220,"wires":[["9c8ff97c.1818"]]},{"id":"a467e078.bba1a8","type":"inject","z":"1c2d6e78.ff8e7a","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":130,"y":700,"wires":[["81217509.012c18"]]},{"id":"81217509.012c18","type":"change","z":"1c2d6e78.ff8e7a","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"payload.i","pt":"msg","to":"DataAIDemoBuilder456685","tot":"str"},{"t":"set","p":"payload.p","pt":"msg","to":"52.118.144.157","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":300,"y":700,"wires":[["f74b2f9b.854bd8"]]},{"id":"a0b28734.9ce0b8","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"msg.url = \"https://api.box.com/oauth2/token\";\nmsg.headers = {'Content-Type':'application/x-www-form-urlencoded'};\nmsg.payload = {\n    'client_id':'w9c2iqi6d1x59tt2tzmnn543t621c0n1',\n    'client_secret':'X6O5m82HPjSorUL3nocXYYFic4oUqElk',\n    'box_subject_type':'enterprise',\n    'box_subject_id':'834103780',\n    'grant_type':'client_credentials'\n};\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":540,"y":1520,"wires":[["1ed58157.979897"]]},{"id":"1ed58157.979897","type":"http request","z":"1c2d6e78.ff8e7a","name":"","method":"POST","ret":"obj","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"","x":740,"y":1520,"wires":[["18e1b957.edf487"]]},{"id":"51a9b07e.980838","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"if (msg.payload == \"Unable to authenticate.\" || msg.payload.includes(\"No invitation found\")){\n    msg.payload = msg.psave;\n    return msg;\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1720,"y":780,"wires":[["32e885b6.b00622"]]},{"id":"32e885b6.b00622","type":"delay","z":"1c2d6e78.ff8e7a","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1880,"y":780,"wires":[["46e7d604.1d7be"]]},{"id":"75c4c04e.3f396","type":"http in","z":"1c2d6e78.ff8e7a","name":"","url":"/boxTK425","method":"post","upload":false,"swaggerDoc":"","x":340,"y":1520,"wires":[["a0b28734.9ce0b8"]]},{"id":"18e1b957.edf487","type":"http response","z":"1c2d6e78.ff8e7a","name":"","statusCode":"","headers":{},"x":1010,"y":1520,"wires":[]},{"id":"9d6db51a.63f2a","type":"inject","z":"1c2d6e78.ff8e7a","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1940,"y":660,"wires":[["44dfdc96.733cbc"]]},{"id":"44dfdc96.733cbc","type":"exec","z":"1c2d6e78.ff8e7a","command":"ls /etc/nginx/sites-enabled/","addpay":false,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"","x":2140,"y":660,"wires":[["96243188.b58928"],[],[]]},{"id":"96243188.b58928","type":"split","z":"1c2d6e78.ff8e7a","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":2350,"y":660,"wires":[["5fa0f395.40ceb4"]]},{"id":"5fa0f395.40ceb4","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"msg.url = \"https://\" + msg.payload + \".daidemos.com/logo.png\";\nmsg.instance = msg.payload.instance;\nmsg.requestTimeout = 5000;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":2500,"y":660,"wires":[["b23fcb4f.0164d8"]]},{"id":"c872090.b25db78","type":"http in","z":"1c2d6e78.ff8e7a","name":"","url":"dbpedia","method":"get","upload":false,"swaggerDoc":"","x":180,"y":1940,"wires":[["c25e6e42.b49a88"]]},{"id":"392563e.1a3419c","type":"http request","z":"1c2d6e78.ff8e7a","name":"","method":"GET","ret":"obj","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"","x":610,"y":1940,"wires":[["e87682a9.ac9f08"]]},{"id":"e87682a9.ac9f08","type":"http response","z":"1c2d6e78.ff8e7a","name":"","statusCode":"","headers":{},"x":890,"y":1940,"wires":[]},{"id":"c25e6e42.b49a88","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"msg.url =\"https://dbpedia.org/sparql?default-graph-uri=http%3A%2F%2Fdbpedia.org&query=PREFIX+dbpedia-owl%3A+%3Chttp%3A%2F%2Fdbpedia.org%2Fontology%2F%3E%0D%0APREFIX+rdfs%3A+%3Chttp%3A%2F%2Fwww.w3.org%2F2000%2F01%2Frdf-schema%23%3E++++++++%0D%0A%0D%0ASELECT+DISTINCT+%3Firi+%3Flogo++%3Findustry+%3Fname%7B%0D%0A++%3Firi+a+dbpedia-owl%3ACompany+%3B%0D%0A+++++++dbpedia-owl%3Aindustry+%3Find%3B+%0D%0A+++++++rdfs%3Alabel+%3Fname++.%0D%0A++%3Find+rdfs%3Alabel+%3Findustry++.%0D%0A++%3Fname+bif%3Acontains+%22%27\" + encodeURI(msg.payload.c) + \"%27%22%40en++.%0D%0A++FILTER%28+langMatches%28lang%28%3Findustry%29%2C%22en%22%29+%29%0D%0AFILTER%28+langMatches%28lang%28%3Fname%29%2C%22en%22%29+%29%0D%0A++OPTIONAL+%7B%3Firi+foaf%3Adepiction%7Cdbpedia-owl%3Athumbnail+%3Flogo+%7D%0D%0A%7D%0D%0Alimit+1&format=application%2Fsparql-results%2Bjson&timeout=30000&signal_void=on&signal_unconnected=on\"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":380,"y":1940,"wires":[["392563e.1a3419c"]]},{"id":"92299e43.4845e8","type":"debug","z":"1c2d6e78.ff8e7a","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1250,"y":160,"wires":[]},{"id":"39f99d90.d0471a","type":"link out","z":"1c2d6e78.ff8e7a","name":"","links":["c599f2c9.41c1a8"],"x":1035,"y":800,"wires":[]},{"id":"c599f2c9.41c1a8","type":"link in","z":"1c2d6e78.ff8e7a","name":"ownerin","links":["39f99d90.d0471a"],"x":585,"y":260,"wires":[["489a5ab7.d8d6fc"]]},{"id":"489a5ab7.d8d6fc","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"var msg2 = {}\nmsg2.socketIOEvent = \"owner\";\nmsg2.payload = {};\nmsg2.payload.owner = msg.payload.account_id;\nmsg2.payload.inst = msg.req.params.instnum;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":680,"y":260,"wires":[["9c8ff97c.1818","d091b8.807de648"]]},{"id":"d091b8.807de648","type":"debug","z":"1c2d6e78.ff8e7a","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":850,"y":280,"wires":[]},{"id":"88e4e433.771fd8","type":"sqlite","z":"1c2d6e78.ff8e7a","mydb":"bb2f6fb4.d4be2","sqlquery":"msg.topic","sql":"select d.account, d.owner, d.instance, d.Timestamp, p.provisioned from demobuilder d left join provisioned p on d.instance = p.instance;","name":"","x":600,"y":1300,"wires":[["2c42c5aa.f2ef4a"]]},{"id":"7de3d0d6.09754","type":"http in","z":"1c2d6e78.ff8e7a","name":"","url":"/odata","method":"get","upload":false,"swaggerDoc":"","x":210,"y":1300,"wires":[["d8050951.ab9b"]]},{"id":"d8050951.ab9b","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"msg.topic = \"select max(t.json) as json, max(d.Timestamp) as Timestamp, '<a href=\\\"\\' || t.instance || '-WAinst.log\\\" target=\\\"_blank\\\">' || max(p.provisioned) || '</a>' as provisioned from tfscript t left join provisioned p on t.instance = p.instance left join demobuilder d  on t.instance = d.instance where d.account_id = '\" + msg.payload.o + \"' group by t.instance;\";\nreturn msg;\n    \n    \n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":400,"y":1300,"wires":[["88e4e433.771fd8"]]},{"id":"2c42c5aa.f2ef4a","type":"function","z":"1c2d6e78.ff8e7a","name":"","func":"//'<a href=\\\"\\\\m\\\\' || REPLACE(t.instance,\\\"-\\\",\\\"/\\\") || '\\\" target=\\\"_blank\\\">' || t.instance || '</a>' as instance,\nfor (var i = 0; i < msg.payload.length; i++) {\n    msg.payload[i].instJSON = JSON.parse(Buffer.from(msg.payload[i].json, 'base64').toString('utf-8'));\n\n    msg.payload[i].instance = '<a href=\\\"\\\\m\\\\' + msg.payload[i].instJSON.companyCompact + '\\\\' + msg.payload[i].instJSON.cid + '\\\" target=\\\"_blank\\\">' + msg.payload[i].instJSON.company + ' - ' + msg.payload[i].instJSON.cid + '</a>'\n\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":800,"y":1300,"wires":[["539e61a7.fa5a4"]]},{"id":"539e61a7.fa5a4","type":"http response","z":"1c2d6e78.ff8e7a","name":"","statusCode":"","headers":{},"x":950,"y":1300,"wires":[]}]
